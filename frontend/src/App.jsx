import React, { useState, useMemo, useEffect } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell, Legend, ScatterChart, Scatter, ZAxis, AreaChart, Area, ComposedChart, ReferenceLine } from 'recharts';
import { getTransactions, getRentals } from './services/api';
const COLORS = ['#0ea5e9','#6366f1','#8b5cf6','#f43f5e','#10b981','#f59e0b','#ec4899','#14b8a6','#ef4444','#3b82f6','#a855f7','#d946ef','#06b6d4','#84cc16','#fb923c','#64748b','#e11d48','#0d9488','#7c3aed','#ca8a04'];
const SC = { CCR:'#ef4444', RCR:'#f59e0b', OCR:'#22c55e' };
const S2F = 10.764;
const mono = "'JetBrains Mono',monospace";const fm=mono;const cp='pointer';
const Tip=({active,payload,label,prefix='$',suffix=''})=>{if(!active||!payload?.length)return null;return(<div style={{background:'#0f172af2',padding:'10px 14px',borderRadius:8,border:'1px solid #ffffff1a',boxShadow:'0 4px 20px #0004'}}><p style={{color:'#94a3b8',fontSize:11,marginBottom:6}}>{label}</p>{payload.map((p,i)=>(<p key={i} style={{color:p.color||'#fff',fontSize:12,margin:'2px 0'}}>{p.name}: {prefix}{typeof p.value==='number'?p.value.toLocaleString(undefined,{maximumFractionDigits:2}):p.value}{suffix}</p>))}</div>);};
const Card=({children,style:s})=><div style={{background:'#ffffff0a',borderRadius:14,padding:20,border:'1px solid #ffffff10',...s}}>{children}</div>;
const Stat=({label,value,color,icon,sub})=>(<div style={{background:'#ffffff0a',borderRadius:12,padding:'14px 16px',border:'1px solid #ffffff10'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}><span style={{color:'#64748b',fontSize:10,textTransform:'uppercase',letterSpacing:'0.5px'}}>{label}</span><span style={{fontSize:14}}>{icon}</span></div><div style={{color,fontSize:18,fontWeight:700,fontFamily:fm}}>{value}</div>{sub&&<div style={{color:'#475569',fontSize:10,marginTop:2}}>{sub}</div>}</div>);
const $=v=>`$${v.toLocaleString(undefined,{maximumFractionDigits:2})}`;
const $c=v=>{const a=Math.abs(v);const s=v<0?'-':'';if(a>=1e9)return`${s}$${(a/1e9).toFixed(2)}B`;if(a>=1e6)return`${s}$${(a/1e6).toFixed(1)}M`;if(a>=1e3)return`${s}$${(a/1e3).toFixed(0)}K`;return`${s}$${Math.round(a)}`;};
const bs={background:'#ffffff10',border:'1px solid #ffffff1a',borderRadius:8,padding:'6px 12px',color:'#e2e8f0',fontSize:12,cursor:cp,outline:'none'};
const h3s={color:'#e2e8f0',fontSize:14,fontWeight:600,marginBottom:16};
const g2c='ura-g2';
const noDataS={display:'flex',alignItems:'center',justifyContent:'center',height:'100%',color:'#475569'};
const pAM=a=>{if(!a)return 0;const p=a.split('-').map(s=>parseFloat(s.trim()));return(p.length===2&&p[0]>0&&p[1]>0)?(p[0]+p[1])/2:p[0]||0;};
const pLQ=ld=>{if(!ld||ld.length!==4)return null;const mm=parseInt(ld.substring(0,2));const yy=parseInt(ld.substring(2,4));const year=yy>50?1900+yy:2000+yy;const q=Math.ceil(mm/3);return{label:`${year} Q${q}`,year,quarter:q,sortKey:year*10+q};};
const getHC=(v,mn,mx)=>{if(mx===mn)return'#0ea5e94d';return`rgba(14,165,233,${0.1+((v-mn)/(mx-mn))*0.8})`;};
const getHT=(v,mn,mx)=>((v-mn)/(mx-mn))>0.6?'#fff':'#cbd5e1';
const getDC=(d,mn,mx)=>{if(d===0)return'#f1f5f94d';if(d>0)return`rgba(34,197,94,${0.1+Math.min(d/(mx||1),1)*0.6})`;return`rgba(239,68,68,${0.1+Math.min(Math.abs(d)/Math.abs(mn||1),1)*0.6})`;};
const SortTh=({label,field,sortField,sortDir,onSort,align})=>(<th onClick={()=>onSort(field)} style={{color:'#94a3b8',fontWeight:500,padding:'10px 12px',textAlign:align||'left',cursor:cp,userSelect:'none',whiteSpace:'nowrap'}}>{label} {sortField===field?(sortDir==='asc'?'â–²':'â–¼'):<span style={{opacity:0.3}}>â‡…</span>}</th>);
export default function Dashboard(){
const[allTransactions,setAllTransactions]=useState([]);
const[allRentals,setAllRentals]=useState([]);
const[loading,setLoading]=useState(true);
const[error,setError]=useState(null);
useEffect(()=>{(async()=>{try{setLoading(true);setError(null);const[tx,rent]=await Promise.all([getTransactions(),getRentals()]);setAllTransactions(tx);setAllRentals(rent);console.log(`Loaded ${tx.length} transactions, ${rent.length} rentals`);}catch(e){console.error(e);setError(e.message);}finally{setLoading(false);}})();},[]);
const[section,setSection]=useState('sales');
const[salesTab,setSalesTab]=useState('overview');
const[rentalTab,setRentalTab]=useState('overview');
const[analyzeTab,setAnalyzeTab]=useState('trends');
const[selectedDistricts,setSelectedDistricts]=useState([]);
const[selectedYears,setSelectedYears]=useState([]);
const[segmentFilter,setSegmentFilter]=useState('All');
const[typeFilter,setTypeFilter]=useState('All');
const[tenureFilter,setTenureFilter]=useState('All');
const[projectFilter,setProjectFilter]=useState('All');
const[projectSearch,setProjectSearch]=useState('');
const[showProjectDD,setShowProjectDD]=useState(false);
const[showDistrictPanel,setShowDistrictPanel]=useState(false);
const[showYearPanel,setShowYearPanel]=useState(false);

const[rentalBedroom,setRentalBedroom]=useState('All');
const[analyzeProject,setAnalyzeProject]=useState('');
const[analyzeSearch,setAnalyzeSearch]=useState('');
const[showAnalyzeDD,setShowAnalyzeDD]=useState(false);
const[analyzeYears,setAnalyzeYears]=useState([]);
const[showAnalyzeYearPanel,setShowAnalyzeYearPanel]=useState(false);
const[pricingArea,setPricingArea]=useState('');

const[pricingFloor,setPricingFloor]=useState('');
const[pricingMode,setPricingMode]=useState('latest');
const[projHeatMetric,setProjHeatMetric]=useState('psf');
const[projShowDiff,setProjShowDiff]=useState(false);
const[heatSelFloor,setHeatSelFloor]=useState('');
const[heatSelYear,setHeatSelYear]=useState(null);
const[heatSelArea,setHeatSelArea]=useState('');
const[saleSortField,setSaleSortField]=useState('contractDate');
const[saleSortDir,setSaleSortDir]=useState('desc');
const[rentSortField,setRentSortField]=useState('leaseDate');
const[rentSortDir,setRentSortDir]=useState('desc');
const[recordsView,setRecordsView]=useState('sales');
const[cmaSelected,setCmaSelected]=useState([]);
const[cmaSortBy,setCmaSortBy]=useState('annReturn');
const allYears=useMemo(()=>[...new Set(allTransactions.map(t=>t.year))].sort(),[allTransactions]);
const districts=useMemo(()=>[...new Set(allTransactions.map(t=>t.district))].sort(),[allTransactions]);
const segments=['All','CCR','RCR','OCR'];
const types=useMemo(()=>['All',...new Set(allTransactions.map(t=>t.propertyType))],[allTransactions]);
const tenures=useMemo(()=>['All',...new Set(allTransactions.map(t=>t.tenure))],[allTransactions]);
const projects=useMemo(()=>['All',...new Set(allTransactions.map(t=>t.project))].sort(),[allTransactions]);
const allProjectNames=useMemo(()=>[...new Set([...allTransactions.map(t=>t.project),...allRentals.map(r=>r.project)])].sort(),[allTransactions,allRentals]);
const filteredProjects=useMemo(()=>{if(!projectSearch.trim())return projects;const q=projectSearch.toLowerCase();return projects.filter(p=>p==='All'||p.toLowerCase().includes(q));},[projects,projectSearch]);
const analyzeFilteredProjects=useMemo(()=>{if(!analyzeSearch.trim())return allProjectNames;return allProjectNames.filter(p=>p.toLowerCase().includes(analyzeSearch.toLowerCase()));},[allProjectNames,analyzeSearch]);
const toggleD=d=>setSelectedDistricts(p=>p.includes(d)?p.filter(x=>x!==d):[...p,d]);
const toggleY=y=>setSelectedYears(p=>p.includes(y)?p.filter(x=>x!==y):[...p,y]);
const normTen=t=>{if(!t)return'Leasehold';const l=t.toLowerCase();return(l==='fh'||l==='freehold'||l.includes('freehold'))?'Freehold':'Leasehold';};
const filtered=useMemo(()=>allTransactions.filter(t=>(selectedDistricts.length===0||selectedDistricts.includes(t.district))&&(selectedYears.length===0||selectedYears.includes(t.year))&&(segmentFilter==='All'||t.marketSegment===segmentFilter)&&(typeFilter==='All'||t.propertyType===typeFilter)&&(tenureFilter==='All'||t.tenure===tenureFilter)&&(projectFilter==='All'||t.project===projectFilter)),[allTransactions,selectedDistricts,selectedYears,segmentFilter,typeFilter,tenureFilter,projectFilter]);
const yearLabel=useMemo(()=>{if(selectedYears.length===0)return`${allYears[0]}â€“${allYears[allYears.length-1]}`;const s=[...selectedYears].sort();return s.length===1?`${s[0]}`:`${s[0]}â€“${s[s.length-1]}`;},[selectedYears,allYears]);
const latestYear=useMemo(()=>filtered.length?filtered.reduce((m,t)=>t.year>m?t.year:m,0):null,[filtered]);
const filteredRentals=useMemo(()=>allRentals.filter(r=>(selectedDistricts.length===0||selectedDistricts.includes(r.district))&&(rentalBedroom==='All'||r.noOfBedRoom===rentalBedroom)),[allRentals,selectedDistricts,rentalBedroom]);
const rentalBedrooms=useMemo(()=>['All',...new Set(allRentals.map(r=>r.noOfBedRoom).filter(Boolean))].sort(),[allRentals]);
const stats=useMemo(()=>{if(!filtered.length)return{count:0,totalVol:0,avgPrice:0,avgPsf:0,medianPsf:0,minPsf:0,maxPsf:0};const p=filtered.map(t=>t.psf).sort((a,b)=>a-b);return{count:filtered.length,totalVol:filtered.reduce((s,t)=>s+t.priceNum,0),avgPrice:filtered.reduce((s,t)=>s+t.priceNum,0)/filtered.length,avgPsf:filtered.reduce((s,t)=>s+t.psf,0)/filtered.length,medianPsf:p[Math.floor(p.length/2)],minPsf:p[0],maxPsf:p[p.length-1]};},[filtered]);
const yoyData=useMemo(()=>{const m={};filtered.forEach(t=>{if(!m[t.year])m[t.year]=[];m[t.year].push(t.psf);});const ys=Object.keys(m).sort();return ys.map((y,i)=>{const avg=m[y].reduce((s,v)=>s+v,0)/m[y].length;const prev=i>0?m[ys[i-1]].reduce((s,v)=>s+v,0)/m[ys[i-1]].length:null;return{year:y,avgPsf:Math.round(avg*100)/100,count:m[y].length,change:prev?Math.round(((avg-prev)/prev)*10000)/100:null};});},[filtered]);
const segmentData=useMemo(()=>{const m={};filtered.forEach(t=>{if(!m[t.marketSegment])m[t.marketSegment]={psfs:[],count:0};m[t.marketSegment].psfs.push(t.psf);m[t.marketSegment].count++;});return Object.entries(m).map(([s,d])=>({name:s,avgPsf:Math.round((d.psfs.reduce((a,v)=>a+v,0)/d.psfs.length)*100)/100,count:d.count}));},[filtered]);
const psfDist=useMemo(()=>{const b={};filtered.forEach(t=>{const k=Math.floor(t.psf/500)*500;b[k]=(b[k]||0)+1;});return Object.entries(b).sort(([a],[b])=>Number(a)-Number(b)).map(([k,c])=>({range:`$${Number(k).toLocaleString()}-${(Number(k)+499).toLocaleString()}`,count:c}));},[filtered]);
const cumData=useMemo(()=>{const m={};filtered.forEach(t=>{m[t.contractDate]=(m[t.contractDate]||0)+t.priceNum;});let c=0;return Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([d,v])=>{c+=v;return{date:d,volume:v,cumulative:c};});},[filtered]);
const typeData=useMemo(()=>{const m={};filtered.forEach(t=>{if(!m[t.propertyType])m[t.propertyType]={psfs:[],count:0};m[t.propertyType].psfs.push(t.psf);m[t.propertyType].count++;});return Object.entries(m).map(([t,d])=>({name:t,avgPsf:Math.round((d.psfs.reduce((s,v)=>s+v,0)/d.psfs.length)*100)/100,count:d.count}));},[filtered]);
const tenureData=useMemo(()=>{const m={};filtered.forEach(t=>{const tn=normTen(t.tenure);if(!m[tn])m[tn]={psfs:[],count:0};m[tn].psfs.push(t.psf);m[tn].count++;});return Object.entries(m).map(([t,d])=>({name:t,avgPsf:Math.round((d.psfs.reduce((s,v)=>s+v,0)/d.psfs.length)*100)/100,count:d.count}));},[filtered]);
const topProj=useMemo(()=>{const m={};filtered.forEach(t=>{if(!m[t.project])m[t.project]={count:0,totalVol:0,psfs:[]};m[t.project].count++;m[t.project].totalVol+=t.priceNum;m[t.project].psfs.push(t.psf);});return Object.entries(m).map(([n,d])=>({name:n.length>24?n.substring(0,24)+'â€¦':n,count:d.count,volume:d.totalVol,avgPsf:Math.round((d.psfs.reduce((s,v)=>s+v,0)/d.psfs.length)*100)/100})).sort((a,b)=>b.count-a.count).slice(0,10);},[filtered]);
const distTrend=useMemo(()=>{const m={};filtered.forEach(t=>{if(!m[t.contractDate])m[t.contractDate]={};if(!m[t.contractDate][t.district])m[t.contractDate][t.district]=[];m[t.contractDate][t.district].push(t.psf);});return Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([d,ds])=>{const r={date:d};Object.entries(ds).forEach(([k,v])=>{r[`D${k}`]=Math.round((v.reduce((s,x)=>s+x,0)/v.length)*100)/100;});return r;});},[filtered]);
const activeDist=useMemo(()=>{const s=new Set();filtered.forEach(t=>s.add(t.district));return[...s].sort();},[filtered]);
const distYoY=useMemo(()=>{const m={};filtered.forEach(t=>{const k=`${t.district}-${t.year}`;if(!m[k])m[k]={district:t.district,year:t.year,psfs:[]};m[k].psfs.push(t.psf);});const ym={};Object.values(m).forEach(d=>{if(!ym[d.year])ym[d.year]={};ym[d.year][`D${d.district}`]=Math.round((d.psfs.reduce((s,v)=>s+v,0)/d.psfs.length)*100)/100;});return Object.entries(ym).sort(([a],[b])=>a.localeCompare(b)).map(([y,d])=>({year:y,...d}));},[filtered]);
const scatterData=useMemo(()=>['CCR','RCR','OCR'].map(seg=>({segment:seg,data:filtered.filter(t=>t.marketSegment===seg).slice(0,200).map(t=>({area:Math.round(t.areaSqft),psf:t.psf,price:t.priceNum,project:t.project}))})),[filtered]);
const floorPrem=useMemo(()=>{const m={};const mLatest={};const latYr=filtered.length?filtered.reduce((mx,t)=>t.year>mx?t.year:mx,0):null;filtered.forEach(t=>{if(!m[t.floorRange])m[t.floorRange]=[];m[t.floorRange].push(t.psf);if(latYr&&t.year===latYr){if(!mLatest[t.floorRange])mLatest[t.floorRange]=[];mLatest[t.floorRange].push(t.psf);}});const fl=["01-05","06-10","11-15","16-20","21-25","26-30","31-35","36-40"];const flIdx=f=>fl.indexOf(f);let prev=null;let prevIdx=null;return fl.filter(f=>m[f]).map(f=>{const latP=mLatest[f];const useLat=latP&&latP.length>0;const psfs=useLat?latP:m[f];const avg=psfs.reduce((s,v)=>s+v,0)/psfs.length;const curIdx=flIdx(f);const gap=prevIdx!==null?curIdx-prevIdx:0;const pd=prev?(avg-prev)/(gap||1):0;const pp=prev?((Math.pow(avg/prev,1/(gap||1))-1)*100):0;prev=avg;prevIdx=curIdx;return{floor:f,avgPsf:Math.round(avg*100)/100,count:m[f].length,premDollar:Math.round(pd*100)/100,premPct:Math.round(pp*100)/100};});},[filtered]);
const rStats=useMemo(()=>{if(!filteredRentals.length)return{count:0,avgRent:0,medianRent:0,avgRentPsf:0};const r=filteredRentals.map(x=>x.rent).sort((a,b)=>a-b);const rp=filteredRentals.map(x=>{const m=pAM(x.areaSqft);return m>0?x.rent/m:0;}).filter(v=>v>0);return{count:filteredRentals.length,avgRent:Math.round(r.reduce((s,v)=>s+v,0)/r.length),medianRent:r[Math.floor(r.length/2)],avgRentPsf:rp.length?Math.round((rp.reduce((s,v)=>s+v,0)/rp.length)*100)/100:0};},[filteredRentals]);
const rTrend=useMemo(()=>{const m={};filteredRentals.forEach(r=>{const q=pLQ(r.leaseDate);if(!q)return;if(!m[q.sortKey])m[q.sortKey]={label:q.label,rents:[],sortKey:q.sortKey};m[q.sortKey].rents.push(r.rent);});return Object.values(m).sort((a,b)=>a.sortKey-b.sortKey).map(q=>({quarter:q.label,avgRent:Math.round(q.rents.reduce((s,v)=>s+v,0)/q.rents.length),count:q.rents.length}));},[filteredRentals]);
const rByDist=useMemo(()=>{const m={};filteredRentals.forEach(r=>{if(!m[r.district])m[r.district]={rents:[],count:0};m[r.district].rents.push(r.rent);m[r.district].count++;});return Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([d,v])=>({district:`D${d}`,avgRent:Math.round(v.rents.reduce((s,r)=>s+r,0)/v.rents.length),count:v.count}));},[filteredRentals]);
const rByBed=useMemo(()=>{const m={};filteredRentals.forEach(r=>{const b=r.noOfBedRoom||'N/A';if(!m[b])m[b]={rents:[],count:0};m[b].rents.push(r.rent);m[b].count++;});return Object.entries(m).sort(([a],[b])=>{if(a==='N/A')return 1;if(b==='N/A')return -1;return a.localeCompare(b);}).map(([b,v])=>({bedroom:b==='N/A'?'Unknown':`${b} BR`,avgRent:Math.round(v.rents.reduce((s,r)=>s+r,0)/v.rents.length),count:v.count}));},[filteredRentals]);
const rPsfDist=useMemo(()=>{const m={};filteredRentals.forEach(r=>{const mid=pAM(r.areaSqft);if(mid<=0)return;if(!m[r.district])m[r.district]={psfs:[],count:0};m[r.district].psfs.push(r.rent/mid);m[r.district].count++;});return Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([d,v])=>({district:`D${d}`,rentPsf:Math.round((v.psfs.reduce((s,r)=>s+r,0)/v.psfs.length)*100)/100,count:v.count}));},[filteredRentals]);
const rDistTrend=useMemo(()=>{const m={};filteredRentals.forEach(r=>{const q=pLQ(r.leaseDate);if(!q)return;if(!m[q.sortKey])m[q.sortKey]={label:q.label,sortKey:q.sortKey,districts:{}};if(!m[q.sortKey].districts[r.district])m[q.sortKey].districts[r.district]=[];m[q.sortKey].districts[r.district].push(r.rent);});return Object.values(m).sort((a,b)=>a.sortKey-b.sortKey).map(q=>{const row={quarter:q.label};Object.entries(q.districts).forEach(([d,rents])=>{row[`D${d}`]=Math.round(rents.reduce((s,v)=>s+v,0)/rents.length);});return row;});},[filteredRentals]);
const activeRDist=useMemo(()=>{const s=new Set();filteredRentals.forEach(r=>s.add(r.district));return[...s].sort();},[filteredRentals]);
const topRentProj=useMemo(()=>{const m={};filteredRentals.forEach(r=>{if(!m[r.project])m[r.project]={count:0,rents:[]};m[r.project].count++;m[r.project].rents.push(r.rent);});return Object.entries(m).map(([n,d])=>({name:n.length>24?n.substring(0,24)+'â€¦':n,count:d.count,avgRent:Math.round(d.rents.reduce((s,v)=>s+v,0)/d.rents.length)})).sort((a,b)=>b.count-a.count).slice(0,10);},[filteredRentals]);
const rByPropType=useMemo(()=>{const m={};filteredRentals.forEach(r=>{const t=r.propertyType||'Unknown';if(!m[t])m[t]={rents:[],count:0};m[t].rents.push(r.rent);m[t].count++;});return Object.entries(m).map(([t,v])=>({type:t,avgRent:Math.round(v.rents.reduce((s,r)=>s+r,0)/v.rents.length),count:v.count})).sort((a,b)=>b.count-a.count);},[filteredRentals]);
const yieldData=useMemo(()=>{if(!filteredRentals.length||!filtered.length)return[];const rm={};filteredRentals.forEach(r=>{const mid=pAM(r.areaSqft);if(mid<=0)return;if(!rm[r.district])rm[r.district]=[];rm[r.district].push(r.rent/mid);});const bm={};filtered.forEach(t=>{if(!bm[t.district])bm[t.district]=[];bm[t.district].push(t.psf);});const res=[];Object.keys(rm).forEach(d=>{if(!bm[d])return;const ar=rm[d].reduce((s,v)=>s+v,0)/rm[d].length;const ab=bm[d].reduce((s,v)=>s+v,0)/bm[d].length;if(ab<=0)return;res.push({district:`D${d}`,rentPsf:Math.round(ar*100)/100,buyPsf:Math.round(ab),yield:Math.round((ar*12/ab)*10000)/100});});return res.sort((a,b)=>b.yield-a.yield);},[filteredRentals,filtered]);
const projInfo=useMemo(()=>{if(!analyzeProject)return null;const tx=allTransactions.find(t=>t.project===analyzeProject);if(tx)return{district:tx.district,segment:tx.marketSegment,type:tx.propertyType,tenure:tx.tenure,street:tx.street};const rt=allRentals.find(r=>r.project===analyzeProject);if(rt)return{district:rt.district,segment:'',type:rt.propertyType,tenure:'',street:rt.street};return null;},[analyzeProject,allTransactions,allRentals]);
const projTxAll=useMemo(()=>analyzeProject?allTransactions.filter(t=>t.project===analyzeProject):[],[analyzeProject,allTransactions]);
const projRentAll=useMemo(()=>analyzeProject?allRentals.filter(r=>r.project===analyzeProject):[],[analyzeProject,allRentals]);
const projAvailYears=useMemo(()=>{const s=new Set();projTxAll.forEach(t=>s.add(t.year));projRentAll.forEach(r=>{const q=pLQ(r.leaseDate);if(q)s.add(q.year);});return[...s].sort();},[projTxAll,projRentAll]);
const analyzeYearLabel=useMemo(()=>{if(analyzeYears.length===0)return'All';const s=[...analyzeYears].sort();return s.length===1?`${s[0]}`:`${s.length} sel`;},[analyzeYears]);
const toggleAY=y=>setAnalyzeYears(p=>p.includes(y)?p.filter(x=>x!==y):[...p,y]);
const projTx=useMemo(()=>analyzeYears.length===0?projTxAll:projTxAll.filter(t=>analyzeYears.includes(t.year)),[projTxAll,analyzeYears]);
const projRent=useMemo(()=>{if(analyzeYears.length===0)return projRentAll;return projRentAll.filter(r=>{const q=pLQ(r.leaseDate);return q&&analyzeYears.includes(q.year);});},[projRentAll,analyzeYears]);
const projSaleStats=useMemo(()=>{if(!projTx.length)return null;const p=projTx.map(t=>t.psf).sort((a,b)=>a-b);return{count:projTx.length,avgPsf:Math.round((projTx.reduce((s,t)=>s+t.psf,0)/projTx.length)*100)/100,medianPsf:p[Math.floor(p.length/2)],minPsf:p[0],maxPsf:p[p.length-1],avgPrice:Math.round(projTx.reduce((s,t)=>s+t.priceNum,0)/projTx.length),totalVol:projTx.reduce((s,t)=>s+t.priceNum,0)};},[projTx]);
const projAllSaleStats=useMemo(()=>{if(!projTxAll.length)return null;const p=projTxAll.map(t=>t.psf).sort((a,b)=>a-b);return{count:projTxAll.length,avgPsf:Math.round((projTxAll.reduce((s,t)=>s+t.psf,0)/projTxAll.length)*100)/100,medianPsf:p[Math.floor(p.length/2)],minPsf:p[0],maxPsf:p[p.length-1],avgPrice:Math.round(projTxAll.reduce((s,t)=>s+t.priceNum,0)/projTxAll.length),totalVol:projTxAll.reduce((s,t)=>s+t.priceNum,0)};},[projTxAll]);
const projRentStats=useMemo(()=>{if(!projRent.length)return null;const r=projRent.map(x=>x.rent).sort((a,b)=>a-b);const rp=projRent.map(x=>{const m=pAM(x.areaSqft);return m>0?x.rent/m:0;}).filter(v=>v>0);return{count:projRent.length,avgRent:Math.round(r.reduce((s,v)=>s+v,0)/r.length),medianRent:r[Math.floor(r.length/2)],avgRentPsf:rp.length?Math.round((rp.reduce((s,v)=>s+v,0)/rp.length)*100)/100:0};},[projRent]);
const projYield=useMemo(()=>{if(!projSaleStats||!projRentStats||!projRentStats.avgRentPsf||!projSaleStats.avgPsf)return null;return Math.round((projRentStats.avgRentPsf*12/projSaleStats.avgPsf)*10000)/100;},[projSaleStats,projRentStats]);
const projLatestSaleYear=useMemo(()=>projTx.length?projTx.reduce((m,t)=>t.year>m?t.year:m,0):null,[projTx]);
const projLatestSaleStats=useMemo(()=>{if(!projLatestSaleYear)return null;const lt=projTx.filter(t=>t.year===projLatestSaleYear);if(!lt.length)return null;const p=lt.map(t=>t.psf).sort((a,b)=>a-b);return{year:projLatestSaleYear,count:lt.length,avgPsf:Math.round((lt.reduce((s,t)=>s+t.psf,0)/lt.length)*100)/100,minPsf:p[0],maxPsf:p[p.length-1]};},[projTx,projLatestSaleYear]);
const projLatestRentYear=useMemo(()=>{if(!projRent.length)return null;let my=0;projRent.forEach(r=>{const q=pLQ(r.leaseDate);if(q&&q.year>my)my=q.year;});return my||null;},[projRent]);
const projLatestRentStats=useMemo(()=>{if(!projLatestRentYear)return null;const lr=projRent.filter(r=>{const q=pLQ(r.leaseDate);return q&&q.year===projLatestRentYear;});if(!lr.length)return null;const rp=lr.map(x=>{const m=pAM(x.areaSqft);return m>0?x.rent/m:0;}).filter(v=>v>0);return{year:projLatestRentYear,count:lr.length,avgRent:Math.round(lr.reduce((s,r)=>s+r.rent,0)/lr.length),avgRentPsf:rp.length?Math.round((rp.reduce((s,v)=>s+v,0)/rp.length)*100)/100:0};},[projRent,projLatestRentYear]);
const projLatestYield=useMemo(()=>{const ly=Math.max(projLatestSaleYear||0,projLatestRentYear||0);if(!ly)return null;const sly=projTx.filter(t=>t.year===ly);const rly=projRent.filter(r=>{const q=pLQ(r.leaseDate);return q&&q.year===ly;});if(!sly.length||!rly.length)return null;const avgBuy=sly.reduce((s,t)=>s+t.psf,0)/sly.length;const rps=rly.map(x=>{const m=pAM(x.areaSqft);return m>0?x.rent/m:0;}).filter(v=>v>0);if(!rps.length||avgBuy<=0)return null;const avgRp=rps.reduce((s,v)=>s+v,0)/rps.length;return{year:ly,yield:Math.round((avgRp*12/avgBuy)*10000)/100,buyPsf:Math.round(avgBuy*100)/100,rentPsf:Math.round(avgRp*100)/100};},[projTx,projRent,projLatestSaleYear,projLatestRentYear]);
const projFloorDetail=useMemo(()=>{const m={};projTx.forEach(t=>{if(!m[t.floorRange])m[t.floorRange]={all:[],latest:[]};m[t.floorRange].all.push(t);if(t.year===projLatestSaleYear)m[t.floorRange].latest.push(t);});const fl=["01-05","06-10","11-15","16-20","21-25","26-30","31-35","36-40"];return fl.filter(f=>m[f]).map(f=>{const a=m[f].all;const l=m[f].latest;const ap=a.map(t=>t.psf);const lp=l.map(t=>t.psf);return{floor:f,allAvgPsf:Math.round((ap.reduce((s,v)=>s+v,0)/ap.length)*100)/100,allMinPsf:ap.reduce((m,v)=>v<m?v:m,Infinity),allMaxPsf:ap.reduce((m,v)=>v>m?v:m,-Infinity),allCount:ap.length,latestAvgPsf:lp.length?Math.round((lp.reduce((s,v)=>s+v,0)/lp.length)*100)/100:null,latestMinPsf:lp.length?lp.reduce((m,v)=>v<m?v:m,Infinity):null,latestMaxPsf:lp.length?lp.reduce((m,v)=>v>m?v:m,-Infinity):null,latestCount:lp.length,areas:a.map(t=>t.areaSqft)};});},[projTx,projLatestSaleYear]);
const projAreas=useMemo(()=>[...new Set(projTx.map(t=>t.areaSqft))].sort((a,b)=>a-b),[projTx]);
const projAllAreas=useMemo(()=>[...new Set(projTxAll.map(t=>t.areaSqft))].sort((a,b)=>a-b),[projTxAll]);
const projMatrixTxs=useMemo(()=>{const area=parseFloat(heatSelArea)||0;return area>0?projTxAll.filter(t=>t.areaSqft===area):projTxAll;},[projTxAll,heatSelArea]);
const projMatrix=useMemo(()=>{const map=new Map();const fo=["01-05","06-10","11-15","16-20","21-25","26-30","31-35","36-40"];const ys=new Set();const fs=new Set();projMatrixTxs.forEach(t=>{const k=`${t.floorRange}-${t.year}`;ys.add(t.year);fs.add(t.floorRange);if(!map.has(k))map.set(k,{totalPsf:0,totalPrice:0,count:0,txs:[]});const c=map.get(k);c.totalPsf+=t.psf;c.totalPrice+=t.priceNum;c.count++;c.txs.push(t);});const cols=[...ys].sort();const rows=fo.filter(f=>fs.has(f));let mnP=Infinity,mxP=-Infinity,mnPr=Infinity,mxPr=-Infinity,mnV=Infinity,mxV=-Infinity;map.forEach(c=>{const a=c.totalPsf/c.count;const b=c.totalPrice/c.count;mnP=Math.min(mnP,a);mxP=Math.max(mxP,a);mnPr=Math.min(mnPr,b);mxPr=Math.max(mxPr,b);mnV=Math.min(mnV,c.count);mxV=Math.max(mxV,c.count);});const dm=new Map();let mdp=0,xdp=0,mdpr=0,xdpr=0,mdv=0,xdv=0;rows.forEach(f=>{let prevIdx=null;cols.forEach((y,i)=>{const k=`${f}-${y}`;const c=map.get(k);if(i===0){dm.set(k,{isBase:true});if(c)prevIdx=i;}else if(c&&prevIdx!==null){const p=map.get(`${f}-${cols[prevIdx]}`);if(p){const gap=parseInt(y)-parseInt(cols[prevIdx]);const rawDpPsf=(c.totalPsf/c.count)-(p.totalPsf/p.count);const rawDpPrice=(c.totalPrice/c.count)-(p.totalPrice/p.count);const rawDv=c.count-p.count;const dp=gap>1?rawDpPsf/gap:rawDpPsf;const dpr=gap>1?rawDpPrice/gap:rawDpPrice;const dv=rawDv;dm.set(k,{isBase:false,diffPsf:dp,diffPrice:dpr,diffVol:dv,gap,rawDiffPsf:rawDpPsf,rawDiffPrice:rawDpPrice});mdp=Math.min(mdp,dp);xdp=Math.max(xdp,dp);mdpr=Math.min(mdpr,dpr);xdpr=Math.max(xdpr,dpr);mdv=Math.min(mdv,dv);xdv=Math.max(xdv,dv);}prevIdx=i;}else if(!c){dm.set(k,{isBase:false});}else{dm.set(k,{isBase:true});prevIdx=i;}});});return{map,dm,cols,rows,mnP,mxP,mnPr,mxPr,mnV,mxV,mdp,xdp,mdpr,xdpr,mdv,xdv};},[projMatrixTxs]);
const heatSelEstimates=useMemo(()=>{if(!heatSelFloor&&!heatSelYear)return null;const area=parseFloat(heatSelArea)||0;const cellKey=heatSelFloor&&heatSelYear?`${heatSelFloor}-${heatSelYear}`:null;const cell=cellKey?projMatrix.map.get(cellKey):null;const cellTxs=cell?cell.txs:[];const floorTxs=heatSelFloor?projTxAll.filter(t=>t.floorRange===heatSelFloor):[];const yearTxs=heatSelYear?projTxAll.filter(t=>t.year===heatSelYear):[];const srt=a=>[...a].sort((x,y)=>y.contractDate.localeCompare(x.contractDate));const calc=(txs)=>{if(!txs.length)return null;const sorted=srt(txs);const avg=Math.round((txs.reduce((s,t)=>s+t.psf,0)/txs.length)*100)/100;return{avgPsf:avg,latestPsf:sorted[0].psf,latest:sorted[0],count:txs.length};};const projAll=calc(projTxAll);const byYear=calc(yearTxs);const byFloor=calc(floorTxs);const byCell=calc(cellTxs);const bySizeAll=area>0?calc(projTxAll.filter(t=>t.areaSqft===area)):null;const bySizeFloor=area>0&&heatSelFloor?calc(projTxAll.filter(t=>t.areaSqft===area&&t.floorRange===heatSelFloor)):null;const bySizeYear=area>0&&heatSelYear?calc(projTxAll.filter(t=>t.areaSqft===area&&t.year===heatSelYear)):null;const byExact=area>0&&heatSelFloor&&heatSelYear?calc(projTxAll.filter(t=>t.areaSqft===area&&t.floorRange===heatSelFloor&&t.year===heatSelYear)):null;return{area,projAll,byYear,byFloor,byCell,bySizeAll,bySizeFloor,bySizeYear,byExact,cellTxs:srt(cellTxs),floorTxs:srt(floorTxs)};},[heatSelFloor,heatSelYear,heatSelArea,projTxAll,projMatrix]);
const projCapGain=useMemo(()=>{const ym={};projTxAll.forEach(t=>{if(!ym[t.year])ym[t.year]={psfs:[],prices:[]};ym[t.year].psfs.push(t.psf);ym[t.year].prices.push(t.priceNum);});const yrs=Object.keys(ym).sort();if(yrs.length<2)return[];const lastYr=yrs[yrs.length-1];const lastAvg=ym[lastYr].psfs.reduce((s,v)=>s+v,0)/ym[lastYr].psfs.length;const lastAvgPrice=ym[lastYr].prices.reduce((s,v)=>s+v,0)/ym[lastYr].prices.length;const now=new Date().getFullYear();return yrs.slice(0,-1).map(y=>{const avg=ym[y].psfs.reduce((s,v)=>s+v,0)/ym[y].psfs.length;const avgP=ym[y].prices.reduce((s,v)=>s+v,0)/ym[y].prices.length;const gain=lastAvg-avg;const gainPct=avg>0?((lastAvg-avg)/avg)*100:0;const hold=parseInt(lastYr)-parseInt(y);const ann=hold>0?Math.pow(lastAvg/avg,1/hold)-1:0;return{buyYear:y,buyPsf:Math.round(avg),buyPrice:Math.round(avgP),currentPsf:Math.round(lastAvg),currentPrice:Math.round(lastAvgPrice),gainPsf:Math.round(gain),gainPct:Math.round(gainPct*10)/10,holdYears:hold,annReturn:Math.round(ann*1000)/10,count:ym[y].psfs.length,latestYear:lastYr};});},[projTxAll]);
const projPsfTrend=useMemo(()=>{const m={};projTx.forEach(t=>{if(!m[t.contractDate])m[t.contractDate]=[];m[t.contractDate].push(t.psf);});return Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([d,ps])=>({date:d,avgPsf:Math.round((ps.reduce((s,v)=>s+v,0)/ps.length)*100)/100,count:ps.length}));},[projTx]);
const projRentTrend=useMemo(()=>{const m={};projRent.forEach(r=>{const q=pLQ(r.leaseDate);if(!q)return;if(!m[q.sortKey])m[q.sortKey]={label:q.label,rents:[],sortKey:q.sortKey};m[q.sortKey].rents.push(r.rent);});return Object.values(m).sort((a,b)=>a.sortKey-b.sortKey).map(q=>({quarter:q.label,avgRent:Math.round(q.rents.reduce((s,v)=>s+v,0)/q.rents.length),count:q.rents.length}));},[projRent]);
const projFloor=useMemo(()=>{const m={};const mLatest={};const latestYr=projTx.length?projTx.reduce((mx,t)=>t.year>mx?t.year:mx,0):null;projTx.forEach(t=>{if(!m[t.floorRange])m[t.floorRange]=[];m[t.floorRange].push(t.psf);if(latestYr&&t.year===latestYr){if(!mLatest[t.floorRange])mLatest[t.floorRange]=[];mLatest[t.floorRange].push(t.psf);}});const fl=["01-05","06-10","11-15","16-20","21-25","26-30","31-35","36-40"];const flIdx=f=>fl.indexOf(f);let prev=null;let prevFloorIdx=null;return fl.filter(f=>m[f]).map(f=>{const latPsf=mLatest[f];const useLat=latPsf&&latPsf.length>0;const psfs=useLat?latPsf:m[f];const avg=psfs.reduce((s,v)=>s+v,0)/psfs.length;const curIdx=flIdx(f);const floorGap=prevFloorIdx!==null?curIdx-prevFloorIdx:0;const pd=prev?(avg-prev)/(floorGap||1):0;const pp=prev?((Math.pow(avg/prev,1/(floorGap||1))-1)*100):0;const rawPd=prev?avg-prev:0;prev=avg;prevFloorIdx=curIdx;return{floor:f,avgPsf:Math.round(avg*100)/100,count:m[f].length,latestCount:mLatest[f]?.length||0,usesLatest:useLat,premDollar:Math.round(pd*100)/100,premPct:Math.round(pp*100)/100,rawPremDollar:Math.round(rawPd*100)/100,floorGap};});},[projTx]);
const projScatter=useMemo(()=>projTx.map(t=>({area:t.areaSqft,psf:t.psf,price:t.priceNum,floor:t.floorRange,date:t.contractDate})),[projTx]);
const projComparison=useMemo(()=>{if(!projInfo||!projTx.length)return[];const dist=projInfo.district;const seg=projInfo.segment;const m={};allTransactions.forEach(t=>{if(!m[t.contractDate])m[t.contractDate]={proj:[],dist:[],seg:[]};if(t.project===analyzeProject)m[t.contractDate].proj.push(t.psf);if(t.district===dist)m[t.contractDate].dist.push(t.psf);if(t.marketSegment===seg)m[t.contractDate].seg.push(t.psf);});return Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([d,v])=>({date:d,project:v.proj.length?Math.round((v.proj.reduce((s,x)=>s+x,0)/v.proj.length)*100)/100:null,district:v.dist.length?Math.round((v.dist.reduce((s,x)=>s+x,0)/v.dist.length)*100)/100:null,segment:v.seg.length?Math.round((v.seg.reduce((s,x)=>s+x,0)/v.seg.length)*100)/100:null}));},[projInfo,projTx,analyzeProject,allTransactions]);
const nearbyProjects=useMemo(()=>{if(!projInfo)return[];const m={};allTransactions.filter(t=>t.district===projInfo.district&&t.project!==analyzeProject).forEach(t=>{if(!m[t.project]){m[t.project]={count:0,psfs:[],street:t.street,type:t.propertyType,tenure:t.tenure,byYear:{}};}m[t.project].count++;m[t.project].psfs.push(t.psf);if(!m[t.project].byYear[t.year])m[t.project].byYear[t.year]=[];m[t.project].byYear[t.year].push(t.psf);});return Object.entries(m).map(([n,d])=>{const yrs=Object.keys(d.byYear).sort();const latYr=yrs[yrs.length-1];const latPsfs=d.byYear[latYr];const firstYr=yrs[0];const firstPsfs=d.byYear[firstYr];const latAvg=latPsfs.reduce((s,v)=>s+v,0)/latPsfs.length;const firstAvg=firstPsfs.reduce((s,v)=>s+v,0)/firstPsfs.length;const hold=parseInt(latYr)-parseInt(firstYr);const totalGainPct=firstAvg>0?((latAvg-firstAvg)/firstAvg)*100:0;const annReturn=hold>0?((Math.pow(latAvg/firstAvg,1/hold)-1)*100):0;return{name:n,street:d.street,type:d.type,tenure:d.tenure,count:d.count,avgPsf:Math.round((d.psfs.reduce((s,v)=>s+v,0)/d.psfs.length)*100)/100,latestPsf:Math.round(latAvg*100)/100,latestYear:parseInt(latYr),firstYear:parseInt(firstYr),totalGainPct:Math.round(totalGainPct*10)/10,annReturn:Math.round(annReturn*10)/10,holdYears:hold,sameStreet:d.street===projInfo.street,byYear:d.byYear,years:yrs};}).sort((a,b)=>{if(a.sameStreet!==b.sameStreet)return a.sameStreet?-1:1;return b.count-a.count;}).slice(0,50);},[projInfo,analyzeProject,allTransactions]);
useEffect(()=>{if(nearbyProjects.length>0){setCmaSelected(nearbyProjects.slice(0,8).map(p=>p.name));}},[analyzeProject]);
const cmaActive=useMemo(()=>{const sel=cmaSelected.length>0?cmaSelected:nearbyProjects.slice(0,8).map(p=>p.name);return nearbyProjects.filter(p=>sel.includes(p.name));},[nearbyProjects,cmaSelected]);
const toggleCma=n=>setCmaSelected(p=>p.includes(n)?p.filter(x=>x!==n):[...p,n]);
const cmaAllYears=useMemo(()=>{const ys=new Set();projTxAll.forEach(t=>ys.add(t.year));cmaActive.forEach(p=>p.years.forEach(y=>ys.add(parseInt(y))));return[...ys].sort();},[projTxAll,cmaActive]);
const cmaHeatData=useMemo(()=>{if(!analyzeProject||!cmaActive.length)return{rows:[],cols:[],map:new Map(),mnP:0,mxP:0,mnA:-Infinity,mxA:Infinity};const cols=cmaAllYears;const projByYr={};projTxAll.forEach(t=>{if(!projByYr[t.year])projByYr[t.year]=[];projByYr[t.year].push(t.psf);});const map=new Map();const allNames=[analyzeProject,...cmaActive.map(p=>p.name)];allNames.forEach(name=>{const byYr=name===analyzeProject?projByYr:cmaActive.find(p=>p.name===name)?.byYear||{};const yrs=cols.filter(y=>{const ps=byYr[y]||byYr[String(y)];return ps&&ps.length;});if(!yrs.length)return;const firstYr=yrs[0];const firstPsfs=byYr[firstYr]||byYr[String(firstYr)];const firstAvg=firstPsfs?firstPsfs.reduce((s,v)=>s+v,0)/firstPsfs.length:0;cols.forEach(y=>{const psfs=byYr[y]||byYr[String(y)];if(psfs&&psfs.length){const avg=psfs.reduce((s,v)=>s+v,0)/psfs.length;const hold=parseInt(y)-parseInt(firstYr);const annReturn=hold>0&&firstAvg>0?((Math.pow(avg/firstAvg,1/hold)-1)*100):0;const totalGain=firstAvg>0?((avg-firstAvg)/firstAvg)*100:0;map.set(`${name}-${y}`,{avg:Math.round(avg),count:psfs.length,annReturn:Math.round(annReturn*10)/10,totalGain:Math.round(totalGain*10)/10,isFirst:y===firstYr});}});});let mnP=Infinity,mxP=-Infinity,mnA=0,mxA=0;map.forEach(c=>{mnP=Math.min(mnP,c.avg);mxP=Math.max(mxP,c.avg);if(!c.isFirst){mnA=Math.min(mnA,c.annReturn);mxA=Math.max(mxA,c.annReturn);}});return{rows:allNames,cols,map,mnP,mxP,mnA,mxA};},[analyzeProject,cmaActive,cmaAllYears,projTxAll]);
const cmaCapGainData=useMemo(()=>{if(!cmaActive.length)return[];const projByYr={};projTxAll.forEach(t=>{if(!projByYr[t.year])projByYr[t.year]=[];projByYr[t.year].push(t.psf);});const projects=[{name:analyzeProject,byYear:projByYr,isSubject:true},...cmaActive.map(p=>({name:p.name,byYear:p.byYear,isSubject:false}))];return projects.map(p=>{const yrs=Object.keys(p.byYear).sort();if(yrs.length<2)return{name:p.name,isSubject:p.isSubject,gainPct:0,annReturn:0,holdYears:0,latestPsf:0,firstPsf:0,gainPsf:0,latestYear:yrs[0]||'',firstYear:yrs[0]||''};const fY=yrs[0],lY=yrs[yrs.length-1];const fA=p.byYear[fY].reduce((s,v)=>s+v,0)/p.byYear[fY].length;const lA=p.byYear[lY].reduce((s,v)=>s+v,0)/p.byYear[lY].length;const hold=parseInt(lY)-parseInt(fY);const gain=fA>0?((lA-fA)/fA)*100:0;const ann=hold>0?((Math.pow(lA/fA,1/hold)-1)*100):0;return{name:p.name,isSubject:p.isSubject,gainPct:Math.round(gain*10)/10,annReturn:Math.round(ann*10)/10,holdYears:hold,latestPsf:Math.round(lA),firstPsf:Math.round(fA),gainPsf:Math.round(lA-fA),latestYear:lY,firstYear:fY};}).sort((a,b)=>{if(a.isSubject)return -1;if(b.isSubject)return 1;return b[cmaSortBy]-a[cmaSortBy];});},[analyzeProject,cmaActive,projTxAll,cmaSortBy]);
const cmaTrendData=useMemo(()=>{if(!cmaActive.length)return[];const projByYr={};projTxAll.forEach(t=>{if(!projByYr[t.year])projByYr[t.year]=[];projByYr[t.year].push(t.psf);});return cmaAllYears.map(y=>{const row={year:y};const ppsfs=projByYr[y];if(ppsfs)row[analyzeProject]=Math.round((ppsfs.reduce((s,v)=>s+v,0)/ppsfs.length)*100)/100;cmaActive.forEach(p=>{const psfs=p.byYear[y]||p.byYear[String(y)];if(psfs&&psfs.length)row[p.name]=Math.round((psfs.reduce((s,v)=>s+v,0)/psfs.length)*100)/100;});return row;});},[analyzeProject,cmaActive,cmaAllYears,projTxAll]);
const projRentByBed=useMemo(()=>{const m={};projRent.forEach(r=>{const b=r.noOfBedRoom||'N/A';if(!m[b])m[b]={rents:[],count:0};m[b].rents.push(r.rent);m[b].count++;});return Object.entries(m).sort(([a],[b])=>{if(a==='N/A')return 1;if(b==='N/A')return -1;return a.localeCompare(b);}).map(([b,v])=>({bedroom:b==='N/A'?'Unknown':`${b} BR`,avgRent:Math.round(v.rents.reduce((s,r)=>s+r,0)/v.rents.length),count:v.count}));},[projRent]);
const sortedProjTx=useMemo(()=>{const d=saleSortDir==='asc'?1:-1;return[...projTx].sort((a,b)=>{const f=saleSortField;if(f==='contractDate')return a.contractDate.localeCompare(b.contractDate)*d;if(typeof a[f]==='number')return(a[f]-b[f])*d;return String(a[f]||'').localeCompare(String(b[f]||''))*d;});},[projTx,saleSortField,saleSortDir]);
const sortedProjRent=useMemo(()=>{const d=rentSortDir==='asc'?1:-1;return[...projRent].sort((a,b)=>{const f=rentSortField;if(f==='leaseDate'){const qa=pLQ(a.leaseDate);const qb=pLQ(b.leaseDate);return((qa?.sortKey||0)-(qb?.sortKey||0))*d;}if(f==='rent')return(a.rent-b.rent)*d;if(f==='areaMid'){return(pAM(a.areaSqft)-pAM(b.areaSqft))*d;}return String(a[f]||'').localeCompare(String(b[f]||''))*d;});},[projRent,rentSortField,rentSortDir]);
const toggleSaleSort=f=>{if(saleSortField===f)setSaleSortDir(d=>d==='asc'?'desc':'asc');else{setSaleSortField(f);setSaleSortDir('desc');}};
const toggleRentSort=f=>{if(rentSortField===f)setRentSortDir(d=>d==='asc'?'desc':'asc');else{setRentSortField(f);setRentSortDir('desc');}};
const salesTabs=[{id:'overview',label:'ğŸ“Š Overview'},{id:'districts',label:'ğŸ“ Districts'},{id:'advanced',label:'ğŸ“ˆ Advanced'},{id:'floor',label:'ğŸ¢ Floor'}];
const rentalTabs=[{id:'overview',label:'ğŸ“Š Overview'},{id:'districts',label:'ğŸ“ Districts'},{id:'projects',label:'ğŸ† Top Projects'},{id:'yield',label:'ğŸ’° Yield'}];
const analyzeTabs=[{id:'trends',label:'ğŸ“ˆ Trends'},{id:'pricing',label:'ğŸ’² Pricing'},{id:'floor',label:'ğŸ¢ Floor'},{id:'cma',label:'ğŸ˜ï¸ CMA'},{id:'yield',label:'ğŸ’° Yield'},{id:'records',label:'ğŸ“‹ Records'}];
const activeTab=section==='sales'?salesTab:section==='rental'?rentalTab:analyzeTab;
const setTab=section==='sales'?setSalesTab:section==='rental'?setRentalTab:setAnalyzeTab;
const tabList=section==='sales'?salesTabs:section==='rental'?rentalTabs:analyzeTabs;
const sectionColor=section==='sales'?'#38bdf8':section==='rental'?'#34d399':'#a78bfa';
const thStyle={color:'#94a3b8',fontWeight:500,padding:'10px 12px',textAlign:'left',fontSize:12};
const tdStyle={padding:'10px 12px',fontSize:12};
if(loading)return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:16,background:'#0f172a'}}><div style={{width:48,height:48,border:'3px solid rgba(56,189,248,0.2)',borderTopColor:'#38bdf8',borderRadius:'50%',animation:'spin 1s linear infinite'}}/><p style={{color:'#94a3b8',fontSize:14}}>Loading URA transaction data...</p><p style={{color:'#475569',fontSize:12}}>Fetching from all batches</p><style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style></div>);
if(error)return(<div style={{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:16,padding:40,background:'#0f172a'}}><div style={{fontSize:48}}>âš ï¸</div><h2 style={{color:'#f87171',fontSize:18,fontWeight:600}}>Failed to Load Data</h2><p style={{color:'#94a3b8',fontSize:13,textAlign:'center',maxWidth:400}}>{error}</p><button onClick={()=>window.location.reload()} style={{background:'#38bdf8',color:'#0f172a',border:'none',borderRadius:8,padding:'10px 24px',fontWeight:600,cursor:cp}}>Retry</button></div>);
const exportCSV=(data,filename)=>{if(!data.length)return;const h=Object.keys(data[0]);const rows=[h.join(','),...data.map(r=>h.map(k=>{const v=r[k];return typeof v==='string'&&v.includes(',')?`"${v}"`:v;}).join(','))];const blob=new Blob([rows.join('\n')],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);};
const exportSales=()=>{const data=(section==='analyze'?projTxAll:filtered).map(t=>({Date:t.contractDate,Project:t.project,Street:t.street,District:t.district,Segment:t.marketSegment,Type:t.propertyType,Tenure:t.tenure,Floor:t.floorRange,Area_sqft:t.areaSqft,PSF:t.psf,Price:t.priceNum,Sale_Type:t.typeOfSale}));exportCSV(data,`ura-sales-${new Date().toISOString().slice(0,10)}.csv`);};
const exportRentals=()=>{const data=(section==='analyze'?projRent:filteredRentals).map(r=>({Project:r.project,Street:r.street,District:r.district,Bedrooms:r.noOfBedRoom,Area:r.areaSqft,Rent:r.rent,Lease_Date:r.leaseDate}));exportCSV(data,`ura-rentals-${new Date().toISOString().slice(0,10)}.csv`);};
return(<>
<style>{`@keyframes spin{to{transform:rotate(360deg)}}
.ura-g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.ura-pad{padding:0 28px 28px}
.ura-stats{padding:12px 28px 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.ura-inv{display:grid;gap:12px}
@media(max-width:768px){
.ura-g2{grid-template-columns:1fr}
.ura-pad{padding:0 12px 20px}
.ura-stats{padding:10px 12px 12px;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px}
}
@media(max-width:480px){
.ura-stats{grid-template-columns:1fr 1fr}
}`}</style>
<div style={{minHeight:'100vh',background:'linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%)',fontFamily:"'DM Sans','Segoe UI',sans-serif"}}>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
{}
<div className='ura-pad' style={{paddingTop:20,paddingBottom:0}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
<div><h1 style={{color:'#f1f5f9',fontSize:24,fontWeight:700,margin:0}}><span style={{color:'#38bdf8'}}>URA</span> Property Analytics</h1><p style={{color:'#64748b',fontSize:12,marginTop:2}}>{allTransactions.length.toLocaleString()} sales Â· {allRentals.length.toLocaleString()} rentals Â· Singapore</p></div>
<div style={{display:'flex',gap:8,alignItems:'center'}}><span style={{background:'#22c55e',width:8,height:8,borderRadius:'50%',display:'inline-block'}}/><span style={{color:'#94a3b8',fontSize:12}}>Live Data</span></div>
<div style={{display:'flex',gap:8,alignItems:'center'}}><span style={{background:'#22c55e',width:8,height:8,borderRadius:'50%',display:'inline-block'}}/><span style={{color:'#94a3b8',fontSize:12}}>Preview</span></div>
</div>
{}
<div style={{display:'flex',gap:0,marginBottom:16,background:'#ffffff0a',borderRadius:12,padding:4,width:'fit-content',border:'1px solid #ffffff10'}}>
{[{id:'sales',label:'ğŸ’° Sales',c:'#38bdf8'},{id:'rental',label:'ğŸ  Rental',c:'#34d399'},{id:'analyze',label:'ğŸ” Analysis',c:'#a78bfa'}].map(s=>(<button key={s.id} onClick={()=>setSection(s.id)} style={{background:section===s.id?`${s.c}18`:'transparent',border:section===s.id?`1px solid ${s.c}4D`:'1px solid transparent',borderRadius:10,padding:'10px 24px',color:section===s.id?s.c:'#64748b',fontSize:13,fontWeight:600,cursor:cp,transition:'all 0.2s'}}>{s.label}</button>))}
</div>
{(showDistrictPanel||showProjectDD||showYearPanel||showAnalyzeDD||showAnalyzeYearPanel)&&<div onClick={()=>{setShowDistrictPanel(false);setShowProjectDD(false);setShowYearPanel(false);setShowAnalyzeDD(false);setShowAnalyzeYearPanel(false);}} style={{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:40}}/>}
{}
{section!=='analyze'&&(<div style={{display:'flex',gap:10,flexWrap:'wrap',alignItems:'flex-start',position:'relative',zIndex:45}}>
<div style={{position:'relative'}}><button onClick={()=>{setShowDistrictPanel(!showDistrictPanel);setShowProjectDD(false);setShowYearPanel(false);}} style={{...bs,minWidth:140,textAlign:'left',display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}}><span>District: {selectedDistricts.length===0?'All':selectedDistricts.length===1?`D${selectedDistricts[0]}`:`${selectedDistricts.length} sel`}</span><span style={{fontSize:10,opacity:0.6}}>â–¼</span></button>{showDistrictPanel&&(<div style={{position:'absolute',top:'100%',left:0,marginTop:4,background:'#1e293b',border:'1px solid #ffffff1f',borderRadius:10,padding:12,zIndex:50,width:280,maxHeight:320,overflowY:'auto',boxShadow:'0 12px 40px #00000080'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:8,paddingBottom:8,borderBottom:'1px solid #ffffff14'}}><span style={{color:'#94a3b8',fontSize:11,fontWeight:600,textTransform:'uppercase'}}>Districts</span><div style={{display:'flex',gap:6}}><button onClick={()=>setSelectedDistricts([...districts])} style={{background:'#38bdf826',border:'1px solid #38bdf84d',borderRadius:5,padding:'2px 8px',color:'#38bdf8',fontSize:10,cursor:cp}}>All</button><button onClick={()=>setSelectedDistricts([])} style={{background:'#ffffff10',border:'1px solid #ffffff1a',borderRadius:5,padding:'2px 8px',color:'#94a3b8',fontSize:10,cursor:cp}}>Clear</button></div></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:2}}>{districts.map(d=><label key={d} onClick={()=>toggleD(d)} style={{display:'flex',alignItems:'center',gap:8,padding:'5px 6px',borderRadius:6,cursor:cp,background:selectedDistricts.includes(d)?'#38bdf814':'transparent'}}><div style={{width:16,height:16,borderRadius:4,border:selectedDistricts.includes(d)?'2px solid #38bdf8':'2px solid #fff3',background:selectedDistricts.includes(d)?'#38bdf8':'transparent',display:'flex',alignItems:'center',justifyContent:'center'}}>{selectedDistricts.includes(d)&&<span style={{color:'#0f172a',fontSize:10,fontWeight:700}}>âœ“</span>}</div><span style={{color:selectedDistricts.includes(d)?'#e2e8f0':'#94a3b8',fontSize:12}}>D{d}</span></label>)}</div><button onClick={()=>setShowDistrictPanel(false)} style={{width:'100%',marginTop:10,padding:'6px 0',background:'#38bdf826',border:'1px solid #38bdf84d',borderRadius:6,color:'#38bdf8',fontSize:11,fontWeight:600,cursor:cp}}>Done</button></div>)}</div>
<div style={{position:'relative'}}><button onClick={()=>{setShowYearPanel(!showYearPanel);setShowDistrictPanel(false);setShowProjectDD(false);}} style={{...bs,minWidth:130,textAlign:'left',display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}}><span>Year: {selectedYears.length===0?'All':selectedYears.length===1?selectedYears[0]:`${selectedYears.length} sel`}</span><span style={{fontSize:10,opacity:0.6}}>â–¼</span></button>{showYearPanel&&(<div style={{position:'absolute',top:'100%',left:0,marginTop:4,background:'#1e293b',border:'1px solid #ffffff1f',borderRadius:10,padding:12,zIndex:50,width:200,boxShadow:'0 12px 40px #00000080'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:8,paddingBottom:8,borderBottom:'1px solid #ffffff14'}}><span style={{color:'#94a3b8',fontSize:11,fontWeight:600,textTransform:'uppercase'}}>Years</span><div style={{display:'flex',gap:6}}><button onClick={()=>setSelectedYears([...allYears])} style={{background:'#38bdf826',border:'1px solid #38bdf84d',borderRadius:5,padding:'2px 8px',color:'#38bdf8',fontSize:10,cursor:cp}}>All</button><button onClick={()=>setSelectedYears([])} style={{background:'#ffffff10',border:'1px solid #ffffff1a',borderRadius:5,padding:'2px 8px',color:'#94a3b8',fontSize:10,cursor:cp}}>Clear</button></div></div>{allYears.map(y=><label key={y} onClick={()=>toggleY(y)} style={{display:'flex',alignItems:'center',gap:8,padding:'5px 6px',borderRadius:6,cursor:cp,background:selectedYears.includes(y)?'#38bdf814':'transparent'}}><div style={{width:16,height:16,borderRadius:4,border:selectedYears.includes(y)?'2px solid #38bdf8':'2px solid #fff3',background:selectedYears.includes(y)?'#38bdf8':'transparent',display:'flex',alignItems:'center',justifyContent:'center'}}>{selectedYears.includes(y)&&<span style={{color:'#0f172a',fontSize:10,fontWeight:700}}>âœ“</span>}</div><span style={{color:selectedYears.includes(y)?'#e2e8f0':'#94a3b8',fontSize:12}}>{y}</span></label>)}<button onClick={()=>setShowYearPanel(false)} style={{width:'100%',marginTop:10,padding:'6px 0',background:'#38bdf826',border:'1px solid #38bdf84d',borderRadius:6,color:'#38bdf8',fontSize:11,fontWeight:600,cursor:cp}}>Done</button></div>)}</div>
{section==='sales'&&<div style={{display:"contents"}}>{[{label:'Segment',value:segmentFilter,set:setSegmentFilter,opts:segments},{label:'Type',value:typeFilter,set:setTypeFilter,opts:types},{label:'Tenure',value:tenureFilter,set:setTenureFilter,opts:tenures}].map(f=><select key={f.label} value={f.value} onChange={e=>f.set(e.target.value)} style={{...bs,minWidth:100}}>{f.opts.map(o=><option key={o} value={o}>{f.label}: {o}</option>)}</select>)}<div style={{position:'relative',minWidth:220}}><div onClick={()=>{setShowProjectDD(!showProjectDD);setShowDistrictPanel(false);setShowYearPanel(false);}} style={{...bs,padding:'0 4px',display:'flex',alignItems:'center'}}><span style={{color:'#64748b',fontSize:12,padding:'6px 8px'}}>ğŸ”</span><input type="text" placeholder={projectFilter==='All'?`Project: All (${projects.length-1})`:projectFilter} value={projectSearch} onChange={e=>{setProjectSearch(e.target.value);setShowProjectDD(true);}} onFocus={()=>{setShowProjectDD(true);setShowDistrictPanel(false);setShowYearPanel(false);}} style={{background:'transparent',border:'none',outline:'none',color:'#e2e8f0',fontSize:12,padding:'6px 4px',flex:1,width:'100%',minWidth:0}}/>{projectFilter!=='All'&&<button onClick={e=>{e.stopPropagation();setProjectFilter('All');setProjectSearch('');}} style={{background:'#ffffff1a',border:'none',borderRadius:4,color:'#94a3b8',fontSize:10,padding:'2px 6px',cursor:cp,marginRight:4}}>âœ•</button>}</div>{showProjectDD&&<div style={{position:'absolute',top:'100%',left:0,right:0,marginTop:4,background:'#1e293b',border:'1px solid #ffffff1f',borderRadius:10,zIndex:50,maxHeight:280,overflowY:'auto',boxShadow:'0 12px 40px #00000080'}}>{filteredProjects.slice(0,50).map(p=><div key={p} onClick={()=>{setProjectFilter(p);setProjectSearch('');setShowProjectDD(false);}} style={{padding:'8px 14px',fontSize:12,cursor:cp,color:p===projectFilter?'#38bdf8':'#cbd5e1',borderBottom:'1px solid #ffffff0a'}} onMouseEnter={e=>e.currentTarget.style.background='#ffffff10'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>{p==='All'?`All Projects (${projects.length-1})`:p}</div>)}</div>}</div></div>}
{section==='rental'&&<select value={rentalBedroom} onChange={e=>setRentalBedroom(e.target.value)} style={{...bs,minWidth:130}}>{rentalBedrooms.map(b=><option key={b} value={b}>Bedrooms: {b}</option>)}</select>}
</div>)}
{}
{section==='analyze'&&(<div style={{display:'flex',gap:12,flexWrap:'wrap',alignItems:'flex-start',position:'relative',zIndex:45}}>
<div style={{position:'relative',minWidth:320,flex:'1 1 320px',maxWidth:500}}>
<div style={{...bs,padding:'0 4px',display:'flex',alignItems:'center',background:'#a78bfa14',border:'1px solid #a78bfa33',borderRadius:12}}><span style={{color:'#a78bfa',fontSize:16,padding:'10px 12px'}}>ğŸ”</span><input type="text" placeholder="Search for a project to analyze..." value={analyzeSearch} onChange={e=>{setAnalyzeSearch(e.target.value);setShowAnalyzeDD(true);}} onFocus={()=>setShowAnalyzeDD(true)} style={{background:'transparent',border:'none',outline:'none',color:'#e2e8f0',fontSize:14,padding:'10px 4px',flex:1,width:'100%',minWidth:0}}/>{analyzeProject&&<button onClick={()=>{setAnalyzeProject('');setAnalyzeSearch('');setAnalyzeYears([]);setPricingArea('');setPricingFloor('');}} style={{background:'#ffffff1a',border:'none',borderRadius:6,color:'#94a3b8',fontSize:11,padding:'4px 10px',cursor:cp,marginRight:6}}>âœ• Clear</button>}</div>
{showAnalyzeDD&&analyzeSearch.trim()&&(<div style={{position:'absolute',top:'100%',left:0,right:0,marginTop:4,background:'#1e293b',border:'1px solid #ffffff1f',borderRadius:10,zIndex:50,maxHeight:320,overflowY:'auto',boxShadow:'0 12px 40px #00000080'}}>{analyzeFilteredProjects.length===0?<div style={{padding:16,color:'#64748b',fontSize:12,textAlign:'center'}}>No projects found</div>:analyzeFilteredProjects.slice(0,30).map(p=><div key={p} onClick={()=>{setAnalyzeProject(p);setAnalyzeSearch(p);setShowAnalyzeDD(false);setAnalyzeYears([]);setPricingArea('');setPricingFloor('');}} style={{padding:'10px 16px',fontSize:13,cursor:cp,color:p===analyzeProject?'#a78bfa':'#cbd5e1',borderBottom:'1px solid #ffffff0a'}} onMouseEnter={e=>e.currentTarget.style.background='#ffffff10'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>{p}</div>)}</div>)}
</div>
{analyzeProject&&projAvailYears.length>0&&(<div style={{position:'relative'}}>
<button onClick={()=>{setShowAnalyzeYearPanel(!showAnalyzeYearPanel);setShowAnalyzeDD(false);}} style={{...bs,minWidth:140,textAlign:'left',display:'flex',alignItems:'center',justifyContent:'space-between',gap:8,padding:'10px 14px',background:'#a78bfa0f',border:'1px solid #a78bfa26',borderRadius:10}}><span style={{color:analyzeYears.length>0?'#a78bfa':'#94a3b8'}}>ğŸ“… Year: {analyzeYearLabel}</span><span style={{fontSize:10,opacity:0.6}}>â–¼</span></button>
{showAnalyzeYearPanel&&(<div style={{position:'absolute',top:'100%',left:0,marginTop:4,background:'#1e293b',border:'1px solid #ffffff1f',borderRadius:10,padding:12,zIndex:50,width:200,boxShadow:'0 12px 40px #00000080'}}>
<div style={{display:'flex',justifyContent:'space-between',marginBottom:8,paddingBottom:8,borderBottom:'1px solid #ffffff14'}}><span style={{color:'#94a3b8',fontSize:11,fontWeight:600,textTransform:'uppercase'}}>Years</span><div style={{display:'flex',gap:6}}><button onClick={()=>setAnalyzeYears([...projAvailYears])} style={{background:'#a78bfa26',border:'1px solid #a78bfa4d',borderRadius:5,padding:'2px 8px',color:'#a78bfa',fontSize:10,cursor:cp}}>All</button><button onClick={()=>setAnalyzeYears([])} style={{background:'#ffffff10',border:'1px solid #ffffff1a',borderRadius:5,padding:'2px 8px',color:'#94a3b8',fontSize:10,cursor:cp}}>Clear</button></div></div>
{projAvailYears.map(y=><label key={y} onClick={()=>toggleAY(y)} style={{display:'flex',alignItems:'center',gap:8,padding:'5px 6px',borderRadius:6,cursor:cp,background:analyzeYears.includes(y)?'#a78bfa14':'transparent'}}><div style={{width:16,height:16,borderRadius:4,border:analyzeYears.includes(y)?'2px solid #a78bfa':'2px solid #fff3',background:analyzeYears.includes(y)?'#a78bfa':'transparent',display:'flex',alignItems:'center',justifyContent:'center'}}>{analyzeYears.includes(y)&&<span style={{color:'#0f172a',fontSize:10,fontWeight:700}}>âœ“</span>}</div><span style={{color:analyzeYears.includes(y)?'#e2e8f0':'#94a3b8',fontSize:12}}>{y}</span></label>)}
<button onClick={()=>setShowAnalyzeYearPanel(false)} style={{width:'100%',marginTop:10,padding:'6px 0',background:'#a78bfa26',border:'1px solid #a78bfa4d',borderRadius:6,color:'#a78bfa',fontSize:11,fontWeight:600,cursor:cp}}>Done</button>
</div>)}
</div>)}
{analyzeYears.length>0&&<div style={{display:'flex',gap:6,alignItems:'center',flexWrap:'wrap',alignSelf:'center'}}><span style={{color:'#64748b',fontSize:11}}>Filtered:</span>{[...analyzeYears].sort((a,b)=>a-b).map(y=><span key={y} style={{background:'#a78bfa1f',border:'1px solid #a78bfa40',borderRadius:6,padding:'2px 8px',fontSize:11,color:'#a78bfa',display:'flex',alignItems:'center',gap:4}}>{y}<span onClick={()=>toggleAY(y)} style={{cursor:cp,opacity:0.7,fontSize:10}}>âœ•</span></span>)}<button onClick={()=>setAnalyzeYears([])} style={{background:'none',border:'none',color:'#64748b',fontSize:11,cursor:cp,textDecoration:'underline'}}>Clear</button></div>}
</div>)}
{}
{section!=='analyze'&&(selectedDistricts.length>0||selectedYears.length>0)&&<div style={{display:'flex',gap:6,marginTop:10,flexWrap:'wrap',alignItems:'center'}}><span style={{color:'#64748b',fontSize:11,marginRight:4}}>Filtered:</span>{[...selectedYears].sort((a,b)=>a-b).map(y=><span key={`y-${y}`} style={{background:'#34d3991f',border:'1px solid #34d39940',borderRadius:6,padding:'2px 8px',fontSize:11,color:'#34d399',display:'flex',alignItems:'center',gap:4}}>{y}<span onClick={()=>toggleY(y)} style={{cursor:cp,opacity:0.7,fontSize:10}}>âœ•</span></span>)}{[...selectedDistricts].sort().map(d=><span key={`d-${d}`} style={{background:'#38bdf81f',border:'1px solid #38bdf840',borderRadius:6,padding:'2px 8px',fontSize:11,color:'#38bdf8',display:'flex',alignItems:'center',gap:4}}>D{d}<span onClick={()=>toggleD(d)} style={{cursor:cp,opacity:0.7,fontSize:10}}>âœ•</span></span>)}<button onClick={()=>{setSelectedDistricts([]);setSelectedYears([]);}} style={{background:'none',border:'none',color:'#64748b',fontSize:11,cursor:cp,textDecoration:'underline'}}>Clear all</button></div>}
{}
{(section!=='analyze'||analyzeProject)&&(<div style={{display:'flex',gap:4,marginTop:14,paddingBottom:16,borderBottom:'1px solid #ffffff10'}}>{tabList.map(t=><button key={t.id} onClick={()=>setTab(t.id)} style={{background:activeTab===t.id?`${sectionColor}18`:'transparent',border:activeTab===t.id?`1px solid ${sectionColor}4D`:'1px solid transparent',borderRadius:8,padding:'8px 16px',color:activeTab===t.id?sectionColor:'#64748b',fontSize:13,fontWeight:500,cursor:cp}}>{t.label}</button>)}</div>)}
</div>
{}
{section!=='analyze'&&<div className='ura-pad' style={{paddingTop:14,paddingBottom:4}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{color:'#64748b',fontSize:11}}>{section==='sales'?'Sales':'Rental'} Â· <span style={{color:'#e2e8f0',fontWeight:600}}>{yearLabel}</span></span><div style={{display:'flex',alignItems:'center',gap:10}}><span style={{color:'#475569',fontSize:11}}>{section==='sales'?`${filtered.length.toLocaleString()} transactions`:`${filteredRentals.length.toLocaleString()} contracts`}</span><button onClick={section==='sales'?exportSales:exportRentals} style={{background:'#ffffff0a',border:'1px solid #ffffff1a',borderRadius:6,padding:'4px 10px',color:'#94a3b8',fontSize:10,cursor:cp,display:'flex',alignItems:'center',gap:4}} title="Export CSV">ğŸ“¥ CSV</button></div></div></div>}
{}
{section!=='analyze'&&<div className='ura-stats'>{section==='sales'?<div style={{display:"contents"}}><Stat label="Transactions" value={stats.count.toLocaleString()} color="#38bdf8" icon="ğŸ“‹"/><Stat label="Total Volume" value={$c(stats.totalVol)} color="#a78bfa" icon="ğŸ’°"/><Stat label="Avg Price" value={$(Math.round(stats.avgPrice))} color="#34d399" icon="ğŸ·ï¸"/><Stat label="Avg PSF" value={$(stats.avgPsf)} color="#fb923c" icon="ğŸ“"/><Stat label="Med PSF" value={$(stats.medianPsf)} color="#f472b6" icon="ğŸ“Š"/><Stat label="PSF Range" value={`${$(stats.minPsf)} â€“ ${$(stats.maxPsf)}`} color="#94a3b8" icon="â†•ï¸"/></div>:<div style={{display:"contents"}}><Stat label="Contracts" value={rStats.count.toLocaleString()} color="#34d399" icon="ğŸ“‹"/><Stat label="Avg Rent" value={`$${rStats.avgRent.toLocaleString()}/mo`} color="#38bdf8" icon="ğŸ’µ"/><Stat label="Med Rent" value={`$${rStats.medianRent.toLocaleString()}/mo`} color="#f472b6" icon="ğŸ“Š"/><Stat label="Avg Rent PSF" value={`$${rStats.avgRentPsf}/mo`} color="#fb923c" icon="ğŸ“"/></div>}</div>}
{}
{section==='sales'&&<div className='ura-pad'>
{salesTab==='overview'&&(<div className={g2c}>
<Card><h3 style={h3s}>YoY PSF</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><ComposedChart data={yoyData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="year" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis yAxisId="left" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><YAxis yAxisId="right" orientation="right" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>`${v}%`}/><Tooltip content={<Tip/>}/><Legend wrapperStyle={{fontSize:11}}/><Bar yAxisId="left" dataKey="avgPsf" name="Avg PSF" fill="#6366f1" radius={[4,4,0,0]} barSize={32}/><Line yAxisId="right" dataKey="change" name="YoY %" stroke="#f59e0b" strokeWidth={2} dot={{r:4,fill:'#f59e0b'}} connectNulls/><ReferenceLine yAxisId="right" y={0} stroke="#ffffff26"/></ComposedChart></ResponsiveContainer></div></Card>
<Card><h3 style={h3s}>ğŸ¯ Market Segment</h3><div style={{height:280,display:'flex',gap:16}}><div style={{flex:1}}><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={segmentData} dataKey="count" nameKey="name" cx="50%" cy="50%" outerRadius={90} innerRadius={50} paddingAngle={3}>{segmentData.map((e,i)=><Cell key={i} fill={SC[e.name]||COLORS[i]}/>)}</Pie><Tooltip content={<Tip prefix=""/>}/><Legend wrapperStyle={{fontSize:11}}/></PieChart></ResponsiveContainer></div><div style={{display:'flex',flexDirection:'column',justifyContent:'center',gap:12}}>{segmentData.map((s,i)=><div key={s.name} style={{display:'flex',alignItems:'center',gap:10}}><div style={{width:10,height:10,borderRadius:3,background:SC[s.name]||COLORS[i]}}/><div><div style={{color:'#e2e8f0',fontSize:13,fontWeight:600}}>{s.name}</div><div style={{color:'#64748b',fontSize:11}}>{$(s.avgPsf)} psf</div></div></div>)}</div></div></Card>
<Card><h3 style={h3s}>PSF Distribution</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={psfDist}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="range" tick={{fill:'#64748b',fontSize:9}} axisLine={false} angle={-30} textAnchor="end" height={60}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><Tooltip content={<Tip prefix=""/>}/><Bar dataKey="count" name="Transactions" fill="#8b5cf6" radius={[4,4,0,0]}/></BarChart></ResponsiveContainer></div></Card>
<Card><h3 style={h3s}>ğŸ“‰ Cumulative Volume</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><AreaChart data={cumData}><defs><linearGradient id="cG" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#0ea5e9" stopOpacity={0.3}/><stop offset="95%" stopColor="#0ea5e9" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="date" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>`$${(v/1e9).toFixed(1)}B`}/><Tooltip content={<Tip/>}/><Area type="monotone" dataKey="cumulative" name="Cumulative" stroke="#0ea5e9" strokeWidth={2} fill="url(#cG)"/></AreaChart></ResponsiveContainer></div></Card>
<Card><h3 style={h3s}>Property Type</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={typeData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="name" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgPsf" name="Avg PSF" fill="#14b8a6" radius={[6,6,0,0]} barSize={50}/></BarChart></ResponsiveContainer></div></Card>
<Card><h3 style={h3s}>Tenure</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={tenureData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="name" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgPsf" name="Avg PSF" radius={[6,6,0,0]} barSize={50}>{tenureData.map((e,i)=><Cell key={i} fill={i===0?'#f59e0b':'#6366f1'}/>)}</Bar></BarChart></ResponsiveContainer></div></Card>
<Card style={{gridColumn:'1/-1'}}><h3 style={h3s}>Top 10 Projects</h3><div style={{height:320}}><ResponsiveContainer width="100%" height="100%"><BarChart layout="vertical" data={topProj}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#ffffff10"/><XAxis type="number" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis dataKey="name" type="category" width={180} tick={{fill:'#94a3b8',fontSize:10}} axisLine={false}/><Tooltip content={<Tip prefix=""/>}/><Bar dataKey="count" name="Transactions" fill="#6366f1" radius={[0,6,6,0]} barSize={18}>{topProj.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer></div></Card>
</div>)}
{salesTab==='districts'&&(<div style={{display:'grid',gap:16}}><Card><h3 style={h3s}>District Trend</h3><div style={{height:420}}><ResponsiveContainer width="100%" height="100%"><LineChart data={distTrend}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="date" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Legend wrapperStyle={{fontSize:10}}/>{activeDist.map((d,i)=><Line key={d} type="monotone" dataKey={`D${d}`} name={`D${d}`} stroke={COLORS[i%COLORS.length]} strokeWidth={1.5} dot={false} connectNulls/>)}</LineChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>District YoY</h3><div style={{height:380}}><ResponsiveContainer width="100%" height="100%"><BarChart data={distYoY}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="year" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Legend wrapperStyle={{fontSize:10}}/>{activeDist.map((d,i)=><Bar key={d} dataKey={`D${d}`} name={`D${d}`} fill={COLORS[i%COLORS.length]} radius={[2,2,0,0]}/>)}</BarChart></ResponsiveContainer></div></Card></div>)}
{salesTab==='advanced'&&(<div style={{display:'grid',gap:16}}><Card><h3 style={h3s}>Price vs Area</h3><div style={{height:420}}><ResponsiveContainer width="100%" height="100%"><ScatterChart><CartesianGrid strokeDasharray="3 3" stroke="#ffffff10"/><XAxis dataKey="area" name="Area" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis dataKey="psf" name="PSF" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><ZAxis dataKey="price" range={[30,200]}/><Tooltip cursor={{strokeDasharray:'3 3'}} content={({payload})=>{if(!payload?.length)return null;const d=payload[0]?.payload;return <div style={{background:'#0f172af2',padding:'10px 14px',borderRadius:8,border:'1px solid #ffffff1a',fontSize:11,color:'#e2e8f0'}}><p style={{fontWeight:600,marginBottom:4}}>{d?.project}</p><p>Area: {d?.area?.toLocaleString()} sqft</p><p>PSF: ${d?.psf?.toLocaleString()}</p><p>Price: ${d?.price?.toLocaleString()}</p></div>;}}/><Legend wrapperStyle={{fontSize:11}}/>{scatterData.map(s=><Scatter key={s.segment} name={s.segment} data={s.data} fill={SC[s.segment]} opacity={0.7}/>)}</ScatterChart></ResponsiveContainer></div></Card>
</div>)}
{salesTab==='floor'&&(<div className={g2c}><Card><h3 style={h3s}>Floor Premium</h3><div style={{height:340}}><ResponsiveContainer width="100%" height="100%"><BarChart data={floorPrem}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="floor" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgPsf" name="Avg PSF" radius={[6,6,0,0]} barSize={28}>{floorPrem.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>Floor Table</h3><div style={{overflowX:'auto'}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}><thead><tr style={{borderBottom:'1px solid #ffffff1a'}}>{['Floor','Avg PSF','Count','Prem $','Prem %'].map(h=><th key={h} style={thStyle}>{h}</th>)}</tr></thead><tbody>{floorPrem.map((f,i)=><tr key={f.floor} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff05'}}><td style={{...tdStyle,color:'#e2e8f0',fontWeight:600,fontFamily:fm}}>{f.floor}</td><td style={{...tdStyle,color:'#38bdf8',fontFamily:fm}}>{$(f.avgPsf)}</td><td style={{...tdStyle,color:'#94a3b8'}}>{f.count}</td><td style={{...tdStyle,color:f.premDollar>0?'#34d399':f.premDollar<0?'#f87171':'#94a3b8',fontFamily:fm}}>{f.premDollar>0?'+':''}{$(f.premDollar)}</td><td style={{...tdStyle,color:f.premPct>0?'#34d399':f.premPct<0?'#f87171':'#94a3b8',fontFamily:fm}}>{f.premPct>0?'+':''}{f.premPct}%</td></tr>)}</tbody></table></div></Card></div>)}
</div>}
{}
{section==='rental'&&<div className='ura-pad'>
{rentalTab==='overview'&&(<div className={g2c}><Card><h3 style={h3s}>ğŸ“ˆ Rental Trend</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><ComposedChart data={rTrend}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="quarter" tick={{fill:'#64748b',fontSize:9}} axisLine={false} angle={-30} textAnchor="end" height={50}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" fill="#6366f1" radius={[4,4,0,0]} barSize={16}/><Line dataKey="avgRent" name="Trend" stroke="#34d399" strokeWidth={2} dot={false}/></ComposedChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>Rent by Bedroom</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={rByBed}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="bedroom" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" radius={[6,6,0,0]} barSize={40}>{rByBed.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>ğŸ“ Avg Rent by District</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={rByDist}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="district" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" fill="#14b8a6" radius={[4,4,0,0]} barSize={16}/></BarChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>ğŸ˜ï¸ Rent by Property Type</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={rByPropType}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="type" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" fill="#f59e0b" radius={[6,6,0,0]} barSize={50}>{rByPropType.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer></div></Card></div>)}
{rentalTab==='districts'&&(<div style={{display:'grid',gap:16}}><Card><h3 style={h3s}>ğŸ“ Rent PSF by District</h3><div style={{height:300}}><ResponsiveContainer width="100%" height="100%"><BarChart data={rPsfDist}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="district" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>`$${v.toFixed(1)}`}/><Tooltip content={<Tip/>}/><Bar dataKey="rentPsf" name="Rent PSF" fill="#f59e0b" radius={[4,4,0,0]} barSize={16}/></BarChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>ğŸ“ District Rental Trend</h3><div style={{height:380}}><ResponsiveContainer width="100%" height="100%"><LineChart data={rDistTrend}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="quarter" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Legend wrapperStyle={{fontSize:10}}/>{activeRDist.slice(0,15).map((d,i)=><Line key={d} type="monotone" dataKey={`D${d}`} name={`D${d}`} stroke={COLORS[i%COLORS.length]} strokeWidth={1.5} dot={false} connectNulls/>)}</LineChart></ResponsiveContainer></div></Card></div>)}
{rentalTab==='projects'&&(<div className={g2c}><Card style={{gridColumn:'1/-1'}}><h3 style={h3s}>ğŸ† Top Rental Projects</h3><div style={{height:340}}><ResponsiveContainer width="100%" height="100%"><BarChart layout="vertical" data={topRentProj}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#ffffff10"/><XAxis type="number" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis dataKey="name" type="category" width={170} tick={{fill:'#94a3b8',fontSize:10}} axisLine={false}/><Tooltip content={({payload})=>{if(!payload?.length)return null;const d=payload[0]?.payload;return <div style={{background:'#0f172af2',padding:'10px 14px',borderRadius:8,border:'1px solid #ffffff1a',fontSize:11,color:'#e2e8f0'}}><p style={{fontWeight:600}}>{d?.name}</p><p>Contracts: {d?.count} Â· Avg: ${d?.avgRent?.toLocaleString()}/mo</p></div>;}}/><Bar dataKey="count" name="Contracts" fill="#34d399" radius={[0,6,6,0]} barSize={18}>{topRentProj.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>ğŸ˜ï¸ Rent by Type</h3><div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><BarChart data={rByPropType}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="type" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" fill="#f59e0b" radius={[6,6,0,0]} barSize={50}>{rByPropType.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer></div></Card><Card><h3 style={h3s}>ğŸ“Š Table</h3><div style={{overflowX:'auto'}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}><thead><tr style={{borderBottom:'1px solid #ffffff1a'}}>{['Project','Contracts','Avg Rent'].map(h=><th key={h} style={thStyle}>{h}</th>)}</tr></thead><tbody>{topRentProj.map((r,i)=><tr key={r.name} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff05'}}><td style={{...tdStyle,color:'#e2e8f0',fontWeight:600}}>{r.name}</td><td style={{...tdStyle,color:'#94a3b8'}}>{r.count}</td><td style={{...tdStyle,color:'#34d399',fontFamily:fm}}>${r.avgRent.toLocaleString()}</td></tr>)}</tbody></table></div></Card></div>)}
{rentalTab==='yield'&&(<div style={{display:'grid',gap:16}}><Card><h3 style={h3s}>ğŸ’° Gross Rental Yield</h3>{yieldData.length===0?<p style={{color:'#475569',fontSize:12,textAlign:'center',padding:20}}>Need both data sets</p>:(<div className={g2c}><div style={{height:Math.max(320,yieldData.length*28)}}><ResponsiveContainer width="100%" height="100%"><BarChart data={yieldData} layout="vertical"><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#ffffff10"/><XAxis type="number" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>`${v}%`}/><YAxis dataKey="district" type="category" width={50} tick={{fill:'#94a3b8',fontSize:11}} axisLine={false}/><Tooltip content={({payload})=>{if(!payload?.length)return null;const d=payload[0]?.payload;return <div style={{background:'#0f172af2',padding:'10px 14px',borderRadius:8,border:'1px solid #ffffff1a',fontSize:11,color:'#e2e8f0'}}><p style={{fontWeight:600}}>{d?.district} Â· Yield: {d?.yield}%</p><p>Rent: ${d?.rentPsf}/mo Â· Buy: ${d?.buyPsf?.toLocaleString()}</p></div>;}}/><Bar dataKey="yield" name="Yield %" radius={[0,6,6,0]} barSize={16}>{yieldData.map((e,i)=><Cell key={i} fill={e.yield>=3?'#22c55e':e.yield>=2.5?'#f59e0b':'#ef4444'}/>)}</Bar></BarChart></ResponsiveContainer></div><div style={{overflowX:'auto'}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}><thead><tr style={{borderBottom:'1px solid #ffffff1a'}}>{['District','Rent PSF','Buy PSF','Yield'].map(h=><th key={h} style={thStyle}>{h}</th>)}</tr></thead><tbody>{yieldData.map((r,i)=><tr key={r.district} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff05'}}><td style={{...tdStyle,color:'#e2e8f0',fontWeight:600,fontFamily:fm}}>{r.district}</td><td style={{...tdStyle,color:'#f59e0b',fontFamily:fm}}>${r.rentPsf}</td><td style={{...tdStyle,color:'#38bdf8',fontFamily:fm}}>${r.buyPsf.toLocaleString()}</td><td style={{...tdStyle,color:r.yield>=3?'#22c55e':r.yield>=2.5?'#f59e0b':'#ef4444',fontWeight:700,fontFamily:fm}}>{r.yield}%</td></tr>)}</tbody></table></div></div>)}</Card><Card><h3 style={h3s}>ğŸ“Š Sale PSF vs Rent PSF</h3><div style={{height:340}}><ResponsiveContainer width="100%" height="100%"><BarChart data={yieldData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="district" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis yAxisId="left" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><YAxis yAxisId="right" orientation="right" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>`$${v}`}/><Tooltip content={<Tip/>}/><Legend wrapperStyle={{fontSize:11}}/><Bar yAxisId="left" dataKey="buyPsf" name="Sale PSF" fill="#38bdf8" radius={[4,4,0,0]} barSize={14}/><Bar yAxisId="right" dataKey="rentPsf" name="Rent PSF/mo" fill="#34d399" radius={[4,4,0,0]} barSize={14}/></BarChart></ResponsiveContainer></div></Card></div>)}
</div>}
{}
{section==='analyze'&&<div className='ura-pad'>
{!analyzeProject?(
<div style={{textAlign:'center',padding:'80px 0'}}><div style={{fontSize:56,marginBottom:16}}>ğŸ”</div><h2 style={{color:'#e2e8f0',fontSize:22,fontWeight:600,marginBottom:8}}>Property Deep Dive</h2><p style={{color:'#64748b',fontSize:14,maxWidth:400,margin:'0 auto'}}>Search for any project above to see comprehensive sales &amp; rental analysis, floor premiums, comparisons, yield, and transaction records.</p></div>
):(
<div>
{}
<div style={{background:'linear-gradient(135deg,#a78bfa14,#38bdf80d)',borderRadius:16,padding:'24px 28px',border:'1px solid #a78bfa26',marginBottom:20}}>
<h2 style={{color:'#f1f5f9',fontSize:22,fontWeight:700,margin:0}}>{analyzeProject}</h2>
{projInfo&&<div style={{display:'flex',gap:12,marginTop:10,flexWrap:'wrap',alignItems:'center'}}>
{[{l:'District',v:`D${projInfo.district}`,c:'#38bdf8'},{l:'Segment',v:projInfo.segment,c:SC[projInfo.segment]||'#94a3b8'},{l:'Type',v:projInfo.type,c:'#e2e8f0'},{l:'Tenure',v:projInfo.tenure,c:'#f59e0b'},{l:'Street',v:projInfo.street,c:'#94a3b8'}].filter(x=>x.v).map(x=><span key={x.l} style={{background:'#ffffff10',borderRadius:8,padding:'4px 12px',fontSize:12}}><span style={{color:'#64748b'}}>{x.l}: </span><span style={{color:x.c,fontWeight:600}}>{x.v}</span></span>)}
<button onClick={exportSales} style={{background:'#a78bfa1a',border:'1px solid #a78bfa4d',borderRadius:6,padding:'4px 10px',color:'#a78bfa',fontSize:10,cursor:cp,display:'flex',alignItems:'center',gap:4,marginLeft:'auto'}} title="Export sales CSV">ğŸ“¥ Sales</button>
<button onClick={exportRentals} style={{background:'#34d3991a',border:'1px solid #34d3994d',borderRadius:6,padding:'4px 10px',color:'#34d399',fontSize:10,cursor:cp,display:'flex',alignItems:'center',gap:4}} title="Export rentals CSV">ğŸ“¥ Rentals</button>
</div>}
<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginTop:20}}>
<div style={{background:'#38bdf80f',borderRadius:12,padding:16,border:'1px solid #38bdf81f'}}>
<div style={{color:'#38bdf8',fontSize:13,fontWeight:600,marginBottom:12}}>ğŸ’° Sales</div>
{projAllSaleStats?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}><div><div style={{color:'#64748b',fontSize:10}}>TRANSACTIONS</div><div style={{color:'#e2e8f0',fontSize:16,fontWeight:700,fontFamily:fm}}>{projAllSaleStats.count}</div></div><div><div style={{color:'#64748b',fontSize:10}}>AVG PSF</div><div style={{color:'#38bdf8',fontSize:16,fontWeight:700,fontFamily:fm}}>{$(projAllSaleStats.avgPsf)}</div></div><div><div style={{color:'#64748b',fontSize:10}}>AVG PRICE</div><div style={{color:'#e2e8f0',fontSize:14,fontWeight:600,fontFamily:fm}}>{$c(projAllSaleStats.avgPrice)}</div></div><div><div style={{color:'#64748b',fontSize:10}}>PSF RANGE</div><div style={{color:'#94a3b8',fontSize:13,fontFamily:fm,fontWeight:600}}>{$(projAllSaleStats.minPsf)}â€“{$(projAllSaleStats.maxPsf)}</div></div>{projLatestSaleStats&&<div style={{gridColumn:'1/-1',marginTop:4,paddingTop:8,borderTop:'1px solid #38bdf81a',display:'flex',gap:12,alignItems:'center',flexWrap:'wrap'}}><span style={{background:'#38bdf826',borderRadius:5,padding:'2px 8px',fontSize:10,fontWeight:700,color:'#38bdf8'}}>{projLatestSaleStats.year}</span><span style={{color:'#64748b',fontSize:10}}>AVG PSF <span style={{color:'#38bdf8',fontWeight:700,fontFamily:fm}}>{$(projLatestSaleStats.avgPsf)}</span></span><span style={{color:'#64748b',fontSize:10}}>RANGE <span style={{color:'#e2e8f0',fontWeight:700,fontFamily:fm}}>{$(projLatestSaleStats.minPsf)}â€“{$(projLatestSaleStats.maxPsf)}</span></span><span style={{color:'#475569',fontSize:10}}>{projLatestSaleStats.count} txns</span></div>}</div>:<div style={{color:'#475569',fontSize:12}}>No sales data</div>}
</div>
<div style={{background:'#34d3990f',borderRadius:12,padding:16,border:'1px solid #34d3991f'}}>
<div style={{color:'#34d399',fontSize:13,fontWeight:600,marginBottom:12}}>ğŸ  Rental{(projLatestYield||projYield)&&<span style={{background:(projLatestYield?projLatestYield.yield:projYield)>=3?'#22c55e33':(projLatestYield?projLatestYield.yield:projYield)>=2.5?'#f59e0b33':'#ef444433',borderRadius:6,padding:'2px 8px',fontSize:11,marginLeft:8,color:(projLatestYield?projLatestYield.yield:projYield)>=3?'#22c55e':(projLatestYield?projLatestYield.yield:projYield)>=2.5?'#f59e0b':'#ef4444'}}>Yield: {projLatestYield?projLatestYield.yield:projYield}%{projLatestYield&&<span style={{opacity:0.7,marginLeft:4,fontSize:10}}>({projLatestYield.year})</span>}</span>}</div>
{projRentStats?<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}><div><div style={{color:'#64748b',fontSize:10}}>CONTRACTS</div><div style={{color:'#e2e8f0',fontSize:16,fontWeight:700,fontFamily:fm}}>{projRentStats.count}</div></div><div><div style={{color:'#64748b',fontSize:10}}>AVG RENT</div><div style={{color:'#34d399',fontSize:16,fontWeight:700,fontFamily:fm}}>${projRentStats.avgRent.toLocaleString()}</div></div><div><div style={{color:'#64748b',fontSize:10}}>MEDIAN RENT</div><div style={{color:'#e2e8f0',fontSize:14,fontWeight:600,fontFamily:fm}}>${projRentStats.medianRent.toLocaleString()}</div></div><div><div style={{color:'#64748b',fontSize:10}}>RENT PSF</div><div style={{color:'#f59e0b',fontSize:13,fontFamily:fm,fontWeight:600}}>${projRentStats.avgRentPsf}/sqft</div></div>{projLatestRentStats&&<div style={{gridColumn:'1/-1',marginTop:4,paddingTop:8,borderTop:'1px solid #34d3991a',display:'flex',gap:12,alignItems:'center',flexWrap:'wrap'}}><span style={{background:'#34d39926',borderRadius:5,padding:'2px 8px',fontSize:10,fontWeight:700,color:'#34d399'}}>{projLatestRentStats.year}</span><span style={{color:'#64748b',fontSize:10}}>AVG RENT <span style={{color:'#34d399',fontWeight:700,fontFamily:fm}}>${projLatestRentStats.avgRent.toLocaleString()}</span></span><span style={{color:'#64748b',fontSize:10}}>RENT PSF <span style={{color:'#f59e0b',fontWeight:700,fontFamily:fm}}>${projLatestRentStats.avgRentPsf}/sqft</span></span><span style={{color:'#475569',fontSize:10}}>{projLatestRentStats.count} contracts</span></div>}</div>:<div style={{color:'#475569',fontSize:12}}>No rental data</div>}
</div>
</div>
</div>
{}
{analyzeTab==='trends'&&(<div className={g2c}>
<Card><h3 style={h3s}>Sale PSF Trend</h3><div style={{height:280}}>{projPsfTrend.length?<ResponsiveContainer width="100%" height="100%"><ComposedChart data={projPsfTrend}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="date" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgPsf" name="Avg PSF" fill="#6366f1" radius={[4,4,0,0]} barSize={12}/><Line dataKey="avgPsf" name="Trend" stroke="#38bdf8" strokeWidth={2} dot={false}/></ComposedChart></ResponsiveContainer>:<div style={noDataS}>No sales data</div>}</div></Card>
<Card><h3 style={h3s}>Rental Trend</h3><div style={{height:280}}>{projRentTrend.length?<ResponsiveContainer width="100%" height="100%"><ComposedChart data={projRentTrend}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="quarter" tick={{fill:'#64748b',fontSize:9}} axisLine={false} angle={-20} textAnchor="end" height={45}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" fill="#10b981" radius={[4,4,0,0]} barSize={16}/><Line dataKey="avgRent" name="Trend" stroke="#34d399" strokeWidth={2} dot={false}/></ComposedChart></ResponsiveContainer>:<div style={noDataS}>No rental data</div>}</div></Card>
<Card><h3 style={h3s}>Rent by Bedroom</h3><div style={{height:280}}>{projRentByBed.length?<ResponsiveContainer width="100%" height="100%"><BarChart data={projRentByBed}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="bedroom" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgRent" name="Avg Rent" radius={[6,6,0,0]} barSize={40}>{projRentByBed.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer>:<div style={noDataS}>No data</div>}</div></Card>
<Card><h3 style={h3s}>Area vs PSF</h3><div style={{height:280}}>{projScatter.length?<ResponsiveContainer width="100%" height="100%"><ScatterChart><CartesianGrid strokeDasharray="3 3" stroke="#ffffff10"/><XAxis dataKey="area" name="Area (sqft)" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis dataKey="psf" name="PSF" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>`$${v}`}/><Tooltip cursor={{strokeDasharray:'3 3'}} content={({payload})=>{if(!payload?.length)return null;const d=payload[0]?.payload;return <div style={{background:'#0f172af2',padding:'10px 14px',borderRadius:8,border:'1px solid #ffffff1a',fontSize:11,color:'#e2e8f0'}}><p>Floor: {d?.floor} Â· {d?.date}</p><p>Area: {d?.area?.toLocaleString()} sqft Â· PSF: ${d?.psf?.toLocaleString()}</p><p>Price: ${d?.price?.toLocaleString()}</p></div>;}}/><Scatter data={projScatter} fill="#a78bfa" opacity={0.8}/></ScatterChart></ResponsiveContainer>:<div style={noDataS}>No data</div>}</div></Card>
</div>)}
{}
{analyzeTab==='pricing'&&(()=>{
const defArea=projAreas.length?projAreas[Math.floor(projAreas.length/2)]:0;
const rawArea=parseFloat(pricingArea)||defArea;
const area=projAreas.length?projAreas.reduce((p,c)=>Math.abs(c-rawArea)<Math.abs(p-rawArea)?c:p):rawArea;
const sf=pricingFloor;
const srt=a=>[...a].sort((a,b)=>b.contractDate.localeCompare(a.contractDate));
const getPsf=(txs)=>{if(!txs.length)return{psf:0,count:0,latest:null,latestPsf:0,avgPsf:0,avgLabel:''};const sorted=srt(txs);const byYr={};txs.forEach(t=>{if(!byYr[t.year])byYr[t.year]=[];byYr[t.year].push(t);});const yrs=Object.keys(byYr).sort().reverse();const isFiltered=analyzeYears.length>0;let avgTx=[],avgLabel='';if(pricingMode==='average'){if(isFiltered){avgTx=txs;const yrList=[...analyzeYears].sort((a,b)=>a-b);avgLabel=yrList.length===1?`${yrList[0]} avg (${txs.length} tx)`:`${yrList[0]}â€“${yrList[yrList.length-1]} avg (${txs.length} tx)`;}else{const minTx=3;let found=false;for(const y of yrs){if(byYr[y].length>=minTx){avgTx=byYr[y];avgLabel=`${y} avg (${byYr[y].length} tx)`;found=true;break;}}if(!found&&yrs.length>=2){avgTx=[...byYr[yrs[0]],...byYr[yrs[1]]];avgLabel=`${yrs[1]}â€“${yrs[0]} avg (${avgTx.length} tx)`;}else if(!found){avgTx=txs;avgLabel=`all-time avg (${txs.length} tx)`;}}}const avgPsfVal=avgTx.length?Math.round((avgTx.reduce((s,t)=>s+t.psf,0)/avgTx.length)*100)/100:0;const allAvgPsf=Math.round((txs.reduce((s,t)=>s+t.psf,0)/txs.length)*100)/100;return{psf:pricingMode==='latest'?sorted[0].psf:avgPsfVal,count:txs.length,latest:sorted[0],latestPsf:sorted[0].psf,avgPsf:allAvgPsf,avgLabel};};
const allTx=analyzeYears.length>0?projTx:projTxAll;
const t1=getPsf(allTx);
const sizeTxAll=area>0?allTx.filter(t=>t.areaSqft===area):[];
const t2=getPsf(sizeTxAll);
const floorTxAll=sf?allTx.filter(t=>t.floorRange===sf):[];
const t3=getPsf(floorTxAll);
const exactTxAll=sf&&area>0?allTx.filter(t=>t.areaSqft===area&&t.floorRange===sf):[];
const t4=getPsf(exactTxAll);
const bestPsf=t4.psf||t2.psf||t3.psf||t1.psf;
const iS={background:'#ffffff10',border:'1px solid #ffffff1f',borderRadius:8,padding:'8px 12px',color:'#e2e8f0',fontSize:13,fontFamily:fm,outline:'none',width:'100%'};
const tR=(tx,n)=>srt(tx).slice(0,n||999).map((t,i)=> <tr key={i} style={{borderBottom:'1px solid #ffffff08'}}>
<td style={{...tdStyle,color:'#94a3b8',fontSize:11,padding:'8px 10px'}}>{t.contractDate}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,fontSize:11,padding:'8px 10px'}}>{t.areaSqft.toLocaleString()}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,fontSize:11,padding:'8px 10px'}}>{t.floorRange}</td>
<td style={{...tdStyle,color:'#38bdf8',fontFamily:fm,fontWeight:600,fontSize:11,padding:'8px 10px'}}>{$(t.psf)}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,fontWeight:600,fontSize:11,padding:'8px 10px'}}>{$c(t.priceNum)}</td></tr>);
const tH=<tr style={{borderBottom:'1px solid #ffffff1a'}}>{['Date','Size','Floor','PSF','Price'].map(h=><th key={h} style={{...thStyle,fontSize:10,padding:'8px 10px'}}>{h}</th>)}</tr>;
const EstCard=({tier,label,desc,psf,count,latest,color,icon,active})=>(<div style={{background:active?`${color}08`:'#ffffff06',border:`1px solid ${active?color+'4d':'#ffffff10'}`,borderRadius:12,padding:'16px 18px',position:'relative',overflow:'hidden'}}>
{active&&<div style={{position:'absolute',top:0,left:0,right:0,height:3,background:color}}/>}
<div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:10}}>
<div style={{display:'flex',alignItems:'center',gap:8}}>
<span style={{fontSize:16}}>{icon}</span>
<div><div style={{color:active?color:'#94a3b8',fontSize:11,fontWeight:700,letterSpacing:0.5}}>{label}</div>
<div style={{color:'#475569',fontSize:9,marginTop:1}}>{desc}</div></div>
</div>
<div style={{background:'#ffffff0a',borderRadius:6,padding:'3px 8px',fontSize:10,color:'#64748b'}}>{count} tx{count!==1?'s':''}</div>
</div>
{psf>0?<><div style={{color:active?'#e2e8f0':'#94a3b8',fontSize:26,fontWeight:800,fontFamily:fm,lineHeight:1}}>{$c(psf*area)}</div>
<div style={{color:'#64748b',fontSize:11,marginTop:6,fontFamily:fm}}>{$(psf)} PSF Ã— {area.toLocaleString()} sqft</div>
{latest&&<div style={{color:'#475569',fontSize:10,marginTop:4}}>Latest: {latest.contractDate} Â· {$(latest.psf)} PSF</div>}
{t1.psf>0&&psf!==t1.psf&&<div style={{color:psf>t1.psf?'#f87171':'#4ade80',fontSize:10,fontWeight:600,fontFamily:fm,marginTop:4}}>{psf>t1.psf?'+':''}{Math.round((psf-t1.psf)/t1.psf*1000)/10}% vs project avg</div>}
</>:<div style={{color:'#475569',fontSize:13,marginTop:4}}>No matching transactions</div>}
</div>);
const hE=heatSelEstimates;const hArea=parseFloat(heatSelArea)||0;
const srtH=a=>[...a].sort((x,y)=>y.contractDate.localeCompare(x.contractDate));
const MiniEst=({label,icon,color,data,area})=>{if(!data)return <div style={{background:'#ffffff06',border:'1px solid #ffffff10',borderRadius:10,padding:'12px 14px',opacity:0.4}}><div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4}}><span style={{fontSize:13}}>{icon}</span><span style={{color:'#64748b',fontSize:10,fontWeight:600}}>{label}</span></div><div style={{color:'#475569',fontSize:11}}>No data</div></div>;
return <div style={{background:`${color}08`,border:`1px solid ${color}33`,borderRadius:10,padding:'12px 14px'}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
<div style={{display:'flex',alignItems:'center',gap:6}}><span style={{fontSize:13}}>{icon}</span><span style={{color,fontSize:10,fontWeight:700}}>{label}</span></div>
<span style={{color:'#475569',fontSize:9,background:'#ffffff0a',borderRadius:4,padding:'2px 6px'}}>{data.count} tx</span></div>
{area>0?<><div style={{color:'#e2e8f0',fontSize:20,fontWeight:800,fontFamily:fm}}>{$c(data.avgPsf*area)}</div>
<div style={{color:'#64748b',fontSize:10,marginTop:2,fontFamily:fm}}>{$(data.avgPsf)} avg Â· {$(data.latestPsf)} latest</div>
<div style={{color:'#475569',fontSize:9,marginTop:2}}>Latest: {data.latest.contractDate}</div></>
:<><div style={{color,fontSize:18,fontWeight:800,fontFamily:fm}}>{$(data.avgPsf)}</div>
<div style={{color:'#64748b',fontSize:10,marginTop:2}}>avg PSF Â· latest {$(data.latestPsf)}</div></>}
</div>;};
return (<div style={{display:'grid',gap:14}}>
<Card style={{padding:'20px 24px'}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
<div style={{color:'#e2e8f0',fontSize:15,fontWeight:600}}>ğŸ·ï¸ Price Estimator</div>
<div style={{display:'flex',background:'#ffffff0a',borderRadius:8,padding:2,border:'1px solid #ffffff10'}}>
<button onClick={()=>setPricingMode('latest')} style={{background:pricingMode==='latest'?'#a78bfa26':'transparent',border:pricingMode==='latest'?'1px solid #a78bfa4d':'1px solid transparent',borderRadius:6,padding:'5px 14px',fontSize:11,color:pricingMode==='latest'?'#a78bfa':'#64748b',cursor:cp,fontWeight:600}}>Latest</button>
<button onClick={()=>setPricingMode('average')} title="Uses the latest year with â‰¥3 transactions. If year filter is active, averages within filtered years." style={{background:pricingMode==='average'?'#a78bfa26':'transparent',border:pricingMode==='average'?'1px solid #a78bfa4d':'1px solid transparent',borderRadius:6,padding:'5px 14px',fontSize:11,color:pricingMode==='average'?'#a78bfa':'#64748b',cursor:cp,fontWeight:600}}>Average</button>
</div></div>
<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:16}}>
<div><label style={{color:'#94a3b8',fontSize:10,fontWeight:600,marginBottom:6,display:'block'}}>UNIT SIZE (SQFT)</label>
{projAreas.length>0?<div style={{display:'flex',gap:4,flexWrap:'wrap'}}>{projAreas.map(a=><button key={a} onClick={()=>setPricingArea(String(a))} style={{background:area===a?'#a78bfa':'#ffffff0a',border:area===a?'1px solid #a78bfa':'1px solid #ffffff1f',borderRadius:6,padding:'6px 12px',fontSize:12,color:area===a?'#fff':'#94a3b8',cursor:cp,fontFamily:fm,fontWeight:area===a?700:400}}>{a.toLocaleString()}</button>)}</div>:<input type="number" value={pricingArea} onChange={e=>setPricingArea(e.target.value)} placeholder="sqft" style={iS}/>}
</div>
<div><label style={{color:'#94a3b8',fontSize:10,fontWeight:600,marginBottom:6,display:'block'}}>FLOOR LEVEL</label>
<select value={pricingFloor} onChange={e=>setPricingFloor(e.target.value)} style={{...iS,cursor:cp}}>
<option value="">All floors</option>
{projFloorDetail.map(f=><option key={f.floor} value={f.floor}>{f.floor} ({f.allCount} tx)</option>)}
</select></div>
</div>
{bestPsf>0&&<div style={{background:'linear-gradient(135deg,#a78bfa14,#38bdf814)',borderRadius:12,padding:'18px 20px',border:'1px solid #a78bfa26',marginBottom:6}}>
<div style={{color:'#94a3b8',fontSize:10,fontWeight:600,letterSpacing:0.5,marginBottom:6,display:'flex',alignItems:'center',gap:6}}>BEST ESTIMATE Â· {pricingMode==='latest'?'LATEST TX':t1.avgLabel?.toUpperCase()||'AVERAGE'}<span title={pricingMode==='latest'?'Based on the single most recent transaction for the best matching tier (exact > size > floor > project)':'Smart average: uses the latest year with â‰¥3 transactions for statistical reliability. If no single year has enough data, combines the latest 2 years. When year filter is active, averages within filtered years only.'} style={{cursor:'help',opacity:0.6,fontSize:12}}>â„¹ï¸</span></div>
<div style={{color:'#e2e8f0',fontSize:32,fontWeight:800,fontFamily:fm,lineHeight:1}}>{$c(bestPsf*area)}</div>
<div style={{color:'#64748b',fontSize:12,marginTop:6}}>{$(bestPsf)} PSF Ã— {area.toLocaleString()} sqft{sf?` Â· Floor ${sf}`:''}</div>
</div>}
</Card>
<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
<EstCard tier={1} label="PROJECT AVG" desc={`All sizes Â· All floors`} psf={t1.psf} count={t1.count} latest={t1.latest} color="#94a3b8" icon="ğŸ“Š" active={!t2.psf&&!t3.psf&&!t4.psf}/>
{area>0&&<EstCard tier={2} label="SIZE MATCH" desc={`${area.toLocaleString()} sqft Â· Any floor`} psf={t2.psf} count={t2.count} latest={t2.latest} color="#38bdf8" icon="ğŸ“" active={t2.psf>0&&!t4.psf}/>}
{sf&&<EstCard tier={3} label="FLOOR MATCH" desc={`Any size Â· Floor ${sf}`} psf={t3.psf} count={t3.count} latest={t3.latest} color="#f59e0b" icon="ğŸ¢" active={t3.psf>0&&!t4.psf}/>}
{sf&&area>0&&<EstCard tier={4} label="EXACT MATCH" desc={`${area.toLocaleString()} sqft Â· Floor ${sf}`} psf={t4.psf} count={t4.count} latest={t4.latest} color="#22c55e" icon="ğŸ¯" active={t4.psf>0}/>}
</div>
{projCapGain.length>0&&<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'20px 20px 16px',borderBottom:'1px solid #ffffff10'}}>
<h3 style={{color:'#e2e8f0',fontSize:15,fontWeight:600,margin:0}}>ğŸ“ˆ Capital Gain Analysis</h3>
<div style={{color:'#475569',fontSize:11,marginTop:4}}>If you bought in year X at avg PSF, what's the gain vs {projCapGain[0]?.latestYear} prices?</div>
</div>
<div style={{padding:'16px 20px'}}>
<div style={{height:280}}><ResponsiveContainer width="100%" height="100%"><ComposedChart data={projCapGain}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="buyYear" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis yAxisId="left" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>v>0?'+$'+v.toLocaleString():'-$'+Math.abs(v).toLocaleString()}/><YAxis yAxisId="right" orientation="right" tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>v+'%'}/><Tooltip content={({payload})=>{if(!payload?.length)return null;const d=payload[0]?.payload;if(!d)return null;const area=parseFloat(heatSelArea)||0;return <div style={{background:'#0f172af2',padding:'12px 16px',borderRadius:10,border:'1px solid #ffffff1a',fontSize:11,color:'#e2e8f0',minWidth:200}}><p style={{fontWeight:700,marginBottom:6}}>Bought in {d.buyYear} ({d.holdYears}yr hold)</p><p>Buy PSF: <span style={{color:'#f87171',fontFamily:fm}}>${d.buyPsf.toLocaleString()}</span></p><p>Current PSF: <span style={{color:'#4ade80',fontFamily:fm}}>${d.currentPsf.toLocaleString()}</span></p><p>Gain/sqft: <span style={{color:d.gainPsf>=0?'#4ade80':'#f87171',fontWeight:700,fontFamily:fm}}>{d.gainPsf>=0?'+':''}{$c(d.gainPsf)}</span></p><p>Total: <span style={{color:d.gainPct>=0?'#4ade80':'#f87171',fontWeight:700}}>{d.gainPct>=0?'+':''}{d.gainPct}%</span> Â· Ann: <span style={{fontFamily:fm}}>{d.annReturn>=0?'+':''}{d.annReturn}%/yr</span></p>{area>0&&<p style={{marginTop:4,borderTop:'1px solid #ffffff1a',paddingTop:4}}>Est. gain for {area.toLocaleString()} sqft: <span style={{color:d.gainPsf>=0?'#4ade80':'#f87171',fontWeight:700,fontFamily:fm}}>{d.gainPsf>=0?'+':''}{$c(d.gainPsf*area)}</span></p>}</div>;}}/><Legend wrapperStyle={{fontSize:11}}/><Bar yAxisId="left" dataKey="gainPsf" name="Gain $/sqft" radius={[4,4,0,0]} barSize={20}>{projCapGain.map((e,i)=><Cell key={i} fill={e.gainPsf>=0?'#22c55e':'#ef4444'}/>)}</Bar><Line yAxisId="right" dataKey="gainPct" name="Gain %" stroke="#a78bfa" strokeWidth={2} dot={{fill:'#a78bfa',r:4}}/><Line yAxisId="right" dataKey="annReturn" name="Ann. Return %" stroke="#f59e0b" strokeWidth={2} strokeDasharray="5 5" dot={{fill:'#f59e0b',r:3}}/></ComposedChart></ResponsiveContainer></div>
<div style={{overflowX:'auto',marginTop:12}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}>
<thead><tr style={{borderBottom:'1px solid #ffffff1a'}}>{['Buy Year','Avg Buy PSF','Current PSF','Gain/sqft','Gain %','Hold','Ann. Return','Tx'].map(h=><th key={h} style={thStyle}>{h}</th>)}</tr></thead>
<tbody>{projCapGain.map((r,i)=><tr key={r.buyYear} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff05'}}>
<td style={{...tdStyle,color:'#e2e8f0',fontWeight:700,fontFamily:fm}}>{r.buyYear}</td>
<td style={{...tdStyle,color:'#f87171',fontFamily:fm}}>${r.buyPsf.toLocaleString()}</td>
<td style={{...tdStyle,color:'#4ade80',fontFamily:fm}}>${r.currentPsf.toLocaleString()}</td>
<td style={{...tdStyle,color:r.gainPsf>=0?'#34d399':'#f87171',fontWeight:600,fontFamily:fm}}>{r.gainPsf>=0?'+':''}{$c(r.gainPsf)}</td>
<td style={{...tdStyle,color:r.gainPct>=0?'#34d399':'#f87171',fontWeight:600,fontFamily:fm}}>{r.gainPct>=0?'+':''}{r.gainPct}%</td>
<td style={{...tdStyle,color:'#94a3b8',fontFamily:fm}}>{r.holdYears}yr</td>
<td style={{...tdStyle,color:r.annReturn>=0?'#34d399':'#f87171',fontFamily:fm}}>{r.annReturn>=0?'+':''}{r.annReturn}%/yr</td>
<td style={{...tdStyle,color:'#64748b'}}>{r.count}</td>
</tr>)}</tbody></table></div>
</div></Card>}
{projTxAll.length>0&&<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'14px 20px',borderBottom:'1px solid #ffffff10',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
<span style={{color:'#e2e8f0',fontSize:13,fontWeight:600}}>All Transactions</span>
<span style={{color:'#64748b',fontSize:11}}>{projTxAll.length} record{projTxAll.length!==1?'s':''}</span>
</div>
<div style={{overflowX:'auto',maxHeight:400,overflowY:'auto'}}><table style={{width:'100%',borderCollapse:'collapse'}}><thead style={{position:'sticky',top:0,background:'#1e293b',zIndex:1}}>{tH}</thead><tbody>{tR(projTxAll,projTxAll.length)}</tbody></table>
</div></Card>}

<Card style={{padding:0,overflow:'hidden'}}><div style={{padding:'20px 20px 16px',borderBottom:'1px solid #ffffff10',display:'flex',flexWrap:'wrap',justifyContent:'space-between',alignItems:'center',gap:12}}>
<h3 style={{color:'#e2e8f0',fontSize:15,fontWeight:600,margin:0}}>Heatmap Â· Floor Ã— Year{hArea>0?` Â· ${Math.round(hArea).toLocaleString()} sqft`:''}</h3>
<div style={{display:'flex',gap:8}}>
<button onClick={()=>setProjShowDiff(!projShowDiff)} style={{background:projShowDiff?'#38bdf833':'#ffffff10',border:projShowDiff?'1px solid #38bdf866':'1px solid #ffffff1a',borderRadius:8,padding:'6px 14px',fontSize:11,cursor:cp,color:projShowDiff?'#38bdf8':'#94a3b8'}}>Â± Changes</button>
<div style={{display:'flex',background:'#ffffff10',borderRadius:8,padding:2}}>{[{key:'psf',label:'$ PSF'},{key:'price',label:'Price'},{key:'volume',label:'Vol'}].map(m=><button key={m.key} onClick={()=>setProjHeatMetric(m.key)} style={{background:projHeatMetric===m.key?'#ffffff1f':'transparent',border:'none',borderRadius:6,padding:'5px 12px',fontSize:11,color:projHeatMetric===m.key?'#e2e8f0':'#64748b',cursor:cp}}>{m.label}</button>)}</div>
</div></div>
<div style={{padding:'8px 20px 0',display:'flex',gap:6,flexWrap:'wrap',alignItems:'center',borderBottom:'1px solid #ffffff08',paddingBottom:10}}>
<span style={{color:'#64748b',fontSize:10,fontWeight:700,textTransform:'uppercase',marginRight:4}}>Size (sqft):</span>
<button onClick={()=>setHeatSelArea('')} style={{background:!hArea?'#a78bfa':'#ffffff0a',border:!hArea?'1px solid #a78bfa':'1px solid #ffffff1f',borderRadius:6,padding:'4px 10px',fontSize:11,color:!hArea?'#fff':'#94a3b8',cursor:cp,fontWeight:!hArea?700:400}}>All sizes</button>
{projAllAreas.map(a=><button key={a} onClick={()=>setHeatSelArea(hArea===a?'':String(a))} style={{background:hArea===a?'#a78bfa':'#ffffff0a',border:hArea===a?'1px solid #a78bfa':'1px solid #ffffff1f',borderRadius:6,padding:'4px 10px',fontSize:11,color:hArea===a?'#fff':'#94a3b8',cursor:cp,fontFamily:fm,fontWeight:hArea===a?700:400}}>{Math.round(a).toLocaleString()}</button>)}
{hArea>0&&<span style={{color:'#a78bfa',fontSize:10,marginLeft:4}}>({projMatrixTxs.length} of {projTxAll.length} tx)</span>}
</div>
<div style={{padding:'12px 20px 4px',color:'#475569',fontSize:10}}>Click any cell to estimate prices â†“</div>
<div style={{padding:'0 20px 20px',overflowX:'auto'}}>{projMatrix.cols.length===0?<div style={{textAlign:'center',padding:40,color:'#64748b'}}>No data</div>:(<div style={{minWidth:400}}>
<div style={{display:'flex'}}><div style={{width:70,flexShrink:0}}/>{projMatrix.cols.map(y=><div key={y} style={{flex:1,minWidth:70,textAlign:'center',fontSize:12,fontWeight:500,color:'#94a3b8',padding:'8px 0',borderBottom:'1px solid #ffffff14'}}>{y}</div>)}<div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>{['Avg Incr.','% Change','Abs. Change','Total %'].map(h=><div key={h} style={{width:90,flexShrink:0,textAlign:'center',fontSize:10,fontWeight:600,color:'#64748b',padding:'8px 4px',borderBottom:'1px solid #ffffff14'}}>{h}</div>)}</div>
{projMatrix.rows.map(floor=>(<div key={floor} style={{display:'flex',borderBottom:'1px solid #ffffff0a'}}>
<div style={{width:70,flexShrink:0,fontSize:12,fontWeight:600,color:'#cbd5e1',padding:'12px 8px',fontFamily:fm}}>{floor}</div>
{projMatrix.cols.map(year=>{const k=`${floor}-${year}`;const cell=projMatrix.map.get(k);const dd=projMatrix.dm.get(k);const isSel=heatSelFloor===floor&&heatSelYear===year;
let dv='-',bg='transparent',tc='#475569';
if(projShowDiff){if(dd&&!dd.isBase){let diff=projHeatMetric==='psf'?dd.diffPsf:projHeatMetric==='price'?dd.diffPrice:dd.diffVol;if(diff!=null){const g=dd.gap||1;dv=projHeatMetric==='volume'?(diff>0?'+':'')+diff:(diff>0?'+':'')+Math.round(diff)+(g>1?'/yr':'');let mn=projHeatMetric==='psf'?projMatrix.mdp:projHeatMetric==='price'?projMatrix.mdpr:projMatrix.mdv;let mx=projHeatMetric==='psf'?projMatrix.xdp:projHeatMetric==='price'?projMatrix.xdpr:projMatrix.xdv;bg=getDC(diff,mn,mx);tc=diff>=0?'#4ade80':'#f87171';}}}
else if(cell){let val;if(projHeatMetric==='psf'){val=Math.round(cell.totalPsf/cell.count);dv=`$${val.toLocaleString()}`;bg=getHC(val,projMatrix.mnP,projMatrix.mxP);tc=getHT(val,projMatrix.mnP,projMatrix.mxP);}else if(projHeatMetric==='price'){val=cell.totalPrice/cell.count;dv=$c(val);bg=getHC(val,projMatrix.mnPr,projMatrix.mxPr);tc=getHT(val,projMatrix.mnPr,projMatrix.mxPr);}else{val=cell.count;dv=val;bg=getHC(val,projMatrix.mnV,projMatrix.mxV);tc=getHT(val,projMatrix.mnV,projMatrix.mxV);}}
return <div key={k} onClick={()=>{if(heatSelFloor===floor&&heatSelYear===year){setHeatSelFloor('');setHeatSelYear(null);}else{setHeatSelFloor(floor);setHeatSelYear(year);}}} style={{flex:1,minWidth:70,height:42,display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontFamily:fm,fontWeight:500,backgroundColor:bg,color:tc,cursor:cp,outline:isSel?'2px solid #a78bfa':'none',outlineOffset:-2,borderRadius:isSel?4:0,position:'relative'}}>{dv}{isSel&&<div style={{position:'absolute',bottom:2,right:4,width:5,height:5,borderRadius:'50%',background:'#a78bfa'}}/>}</div>;})}
{(()=>{const pairs=projMatrix.cols.map(y=>{const c=projMatrix.map.get(`${floor}-${y}`);return c?{y:parseInt(y),psf:c.totalPsf/c.count,price:c.totalPrice/c.count,vol:c.count}:null;}).filter(Boolean);if(pairs.length<2){return <><div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>{[0,1,2,3].map(i=><div key={i} style={{width:90,flexShrink:0,height:42,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,color:'#475569'}}>â€“</div>)}</>;}
const getV=v=>projHeatMetric==='psf'?v.psf:projHeatMetric==='price'?v.price:v.vol;const first=getV(pairs[0]);const last=getV(pairs[pairs.length-1]);
const totalYears=pairs[pairs.length-1].y-pairs[0].y;
const diffs=[];const pctDiffs=[];for(let i=1;i<pairs.length;i++){const gap=pairs[i].y-pairs[i-1].y;const d=getV(pairs[i])-getV(pairs[i-1]);const perYr=gap>1?d/gap:d;for(let g=0;g<gap;g++){diffs.push(perYr);}const p=getV(pairs[i-1]);if(p){const pctPerYr=gap>1?((Math.pow(getV(pairs[i])/p,1/gap)-1)*100):((getV(pairs[i])-p)/p)*100;for(let g=0;g<gap;g++){pctDiffs.push(pctPerYr);}}}
const avgIncr=Math.round(diffs.reduce((s,v)=>s+v,0)/diffs.length);const avgPct=pctDiffs.length?Math.round((pctDiffs.reduce((s,v)=>s+v,0)/pctDiffs.length)*10)/10:0;const absChg=Math.round(last-first);const totalPct=first?Math.round(((last-first)/first)*1000)/10:0;
const sc=v=>v>0?'#34d399':v<0?'#f87171':'#64748b';const ar=v=>v>0?'â†—':v<0?'â†˜':'';
return <><div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>{[{v:avgIncr>0?'+'+avgIncr:avgIncr},{v:ar(avgPct)+' '+Math.abs(avgPct)+'%'},{v:absChg>0?'+'+absChg:absChg},{v:ar(totalPct)+' '+Math.abs(totalPct)+'%'}].map((s,i)=><div key={i} style={{width:90,flexShrink:0,height:42,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:600,color:sc(i<2?avgIncr:absChg)}}>{s.v}</div>)}</>;})()}
</div>))}
</div>)}
<div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:16,padding:'12px 20px',borderTop:'1px solid #ffffff0a'}}>
<div style={{display:'flex',alignItems:'center',gap:8}}><span style={{color:'#64748b',fontSize:10}}>Low</span><div style={{width:80,height:8,borderRadius:4,background:'linear-gradient(90deg,#0ea5e940,#0ea5e9,#06b6d4)'}}/><span style={{color:'#64748b',fontSize:10}}>High</span></div>
<span style={{color:'#475569',fontSize:10,fontStyle:'italic'}}>*Stats calc based on available yearly data points</span>
</div></div></Card>

{(heatSelFloor||heatSelYear)&&hE&&<Card style={{background:'linear-gradient(135deg,#1e293b,#0f172a)',border:'1px solid #a78bfa33'}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:16,flexWrap:'wrap',gap:10}}>
<div><div style={{color:'#a78bfa',fontSize:14,fontWeight:700}}>ğŸ¯ Price Estimates{heatSelFloor?` Â· Floor ${heatSelFloor}`:''}{heatSelYear?` Â· ${heatSelYear}`:''}{hArea>0?` Â· ${Math.round(hArea).toLocaleString()} sqft`:''}</div>
<div style={{color:'#475569',fontSize:11,marginTop:2}}>Based on {hE.projAll?.count||0} total project transactions</div></div>
</div>
<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:10}}>
<MiniEst label="PROJECT ALL" icon="ğŸ“Š" color="#94a3b8" data={hE.projAll} area={hArea}/>
{heatSelYear&&<MiniEst label={`${heatSelYear} ALL`} icon="ğŸ“…" color="#6366f1" data={hE.byYear} area={hArea}/>}
{heatSelFloor&&<MiniEst label={`FL ${heatSelFloor} ALL`} icon="ğŸ¢" color="#f59e0b" data={hE.byFloor} area={hArea}/>}
{heatSelFloor&&heatSelYear&&<MiniEst label={`FL ${heatSelFloor} Â· ${heatSelYear}`} icon="ğŸ”¥" color="#ef4444" data={hE.byCell} area={hArea}/>}
{hArea>0&&<MiniEst label={`${Math.round(hArea).toLocaleString()} sqft ALL`} icon="ğŸ“" color="#38bdf8" data={hE.bySizeAll} area={hArea}/>}
{hArea>0&&heatSelFloor&&<MiniEst label={`${Math.round(hArea).toLocaleString()} Â· FL ${heatSelFloor}`} icon="ğŸ¯" color="#22c55e" data={hE.bySizeFloor} area={hArea}/>}
{hArea>0&&heatSelYear&&<MiniEst label={`${Math.round(hArea).toLocaleString()} Â· ${heatSelYear}`} icon="ğŸ“†" color="#14b8a6" data={hE.bySizeYear} area={hArea}/>}
{hArea>0&&heatSelFloor&&heatSelYear&&<MiniEst label={`${Math.round(hArea).toLocaleString()} Â· FL ${heatSelFloor} Â· ${heatSelYear}`} icon="ğŸ’" color="#a78bfa" data={hE.byExact} area={hArea}/>}
</div>
{hE.cellTxs.length>0&&<div style={{marginTop:14,borderTop:'1px solid #ffffff10',paddingTop:14}}>
<div style={{color:'#94a3b8',fontSize:11,fontWeight:600,marginBottom:8}}>Transactions Â· FL {heatSelFloor} Â· {heatSelYear} ({hE.cellTxs.length})</div>
<div style={{overflowX:'auto',maxHeight:200,overflowY:'auto'}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:11}}>
<thead style={{position:'sticky',top:0,background:'#1e293b'}}><tr style={{borderBottom:'1px solid #ffffff1a'}}>{['Date','Size','Floor','PSF','Price'].map(h=><th key={h} style={{...thStyle,fontSize:10,padding:'6px 10px'}}>{h}</th>)}</tr></thead>
<tbody>{hE.cellTxs.map((t,i)=><tr key={i} style={{borderBottom:'1px solid #ffffff08'}}>
<td style={{...tdStyle,color:'#94a3b8',padding:'6px 10px'}}>{t.contractDate}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,padding:'6px 10px'}}>{t.areaSqft.toLocaleString()}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,padding:'6px 10px'}}>{t.floorRange}</td>
<td style={{...tdStyle,color:'#38bdf8',fontFamily:fm,fontWeight:600,padding:'6px 10px'}}>{$(t.psf)}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,fontWeight:600,padding:'6px 10px'}}>{$c(t.priceNum)}</td>
</tr>)}</tbody></table></div></div>}
</Card>}

</div>);})()}
{analyzeTab==='floor'&&(<div className={g2c}>
<Card><h3 style={h3s}>Floor Premium</h3><div style={{height:340}}>{projFloor.length?<ResponsiveContainer width="100%" height="100%"><BarChart data={projFloor}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="floor" tick={{fill:'#64748b',fontSize:10}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Bar dataKey="avgPsf" name="Avg PSF" radius={[6,6,0,0]} barSize={28}>{projFloor.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Bar></BarChart></ResponsiveContainer>:<div style={noDataS}>No floor data</div>}</div></Card>
<Card><h3 style={h3s}>Floor Table</h3><div style={{overflowX:'auto'}}>{projFloor.length?<table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}><thead><tr style={{borderBottom:'1px solid #ffffff1a'}}>{['Floor','Avg PSF','Count','Prem $/lvl','Prem %/lvl','Source'].map(h=><th key={h} style={thStyle}>{h}</th>)}</tr></thead><tbody>{projFloor.map((f,i)=><tr key={f.floor} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff05'}}><td style={{...tdStyle,color:'#e2e8f0',fontWeight:600,fontFamily:fm}}>{f.floor}</td><td style={{...tdStyle,color:'#38bdf8',fontFamily:fm}}>{$(f.avgPsf)}</td><td style={{...tdStyle,color:'#94a3b8'}}>{f.usesLatest?`${f.latestCount} (latest)`:f.count}</td><td style={{...tdStyle,color:f.premDollar>0?'#34d399':f.premDollar<0?'#f87171':'#94a3b8',fontFamily:fm}}>{f.premDollar>0?'+':''}{$(f.premDollar)}{f.floorGap>1?<span style={{color:'#64748b',fontSize:9}}> /{f.floorGap}lvl</span>:''}</td><td style={{...tdStyle,color:f.premPct>0?'#34d399':f.premPct<0?'#f87171':'#94a3b8',fontFamily:fm}}>{f.premPct>0?'+':''}{f.premPct}%</td><td style={{...tdStyle,fontSize:10,color:f.usesLatest?'#a78bfa':'#475569'}}>{f.usesLatest?'âœ“ Latest':'All-time'}</td></tr>)}</tbody></table>:<div style={{color:'#475569',fontSize:12,textAlign:'center',padding:40}}>No floor data</div>}</div></Card>
</div>)}
{}
{analyzeTab==='cma'&&(()=>{const getAC=(v,mn,mx)=>{if(v===0)return'#f1f5f91a';if(v>0)return`rgba(34,197,94,${0.1+Math.min(v/(mx||1),1)*0.7})`;return`rgba(239,68,68,${0.1+Math.min(Math.abs(v)/Math.abs(mn||1),1)*0.7})`;};const getAT=v=>Math.abs(v)>3?'#fff':'#cbd5e1';const cmaPill=(key,label,cur,set,ac)=><button onClick={()=>set(key)} style={{background:cur===key?`${ac}26`:'#ffffff0a',border:cur===key?`1px solid ${ac}4d`:'1px solid #ffffff10',borderRadius:6,padding:'4px 10px',fontSize:10,color:cur===key?ac:'#64748b',cursor:cp,fontWeight:600}}>{label}</button>;return <div style={{display:'grid',gap:16}}>
{/* Selector */}
<Card><div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:12,flexWrap:'wrap',gap:8}}>
<div><h3 style={{color:'#e2e8f0',fontSize:15,fontWeight:600,margin:0}}>ğŸ˜ï¸ Comparative Market Analysis</h3>
<div style={{color:'#64748b',fontSize:11,marginTop:2}}>D{projInfo?.district} Â· {nearbyProjects.filter(p=>p.sameStreet).length} same street Â· {nearbyProjects.length} nearby Â· {cmaActive.length} selected</div></div>
<div style={{display:'flex',gap:6}}><button onClick={()=>setCmaSelected(nearbyProjects.filter(p=>p.sameStreet).map(p=>p.name))} style={{background:'#22c55e1a',border:'1px solid #22c55e4d',borderRadius:6,padding:'4px 10px',fontSize:10,color:'#4ade80',cursor:cp,fontWeight:600}}>Same Street</button>
<button onClick={()=>setCmaSelected(nearbyProjects.slice(0,8).map(p=>p.name))} style={{background:'#38bdf81a',border:'1px solid #38bdf84d',borderRadius:6,padding:'4px 10px',fontSize:10,color:'#38bdf8',cursor:cp,fontWeight:600}}>Top 8</button>
<button onClick={()=>setCmaSelected(nearbyProjects.slice(0,20).map(p=>p.name))} style={{background:'#a78bfa1a',border:'1px solid #a78bfa4d',borderRadius:6,padding:'4px 10px',fontSize:10,color:'#a78bfa',cursor:cp,fontWeight:600}}>Top 20</button>
<button onClick={()=>setCmaSelected([])} style={{background:'#ffffff0a',border:'1px solid #ffffff1a',borderRadius:6,padding:'4px 10px',fontSize:10,color:'#94a3b8',cursor:cp}}>Clear</button></div>
</div>
<div style={{display:'flex',gap:4,flexWrap:'wrap',maxHeight:120,overflowY:'auto',padding:'8px 0'}}>
{nearbyProjects.map((p,i)=>{const sel=cmaSelected.includes(p.name);return <button key={p.name} onClick={()=>toggleCma(p.name)} style={{background:sel?p.sameStreet?'#22c55e26':'#38bdf826':'#ffffff06',border:`1px solid ${sel?p.sameStreet?'#22c55e4d':'#38bdf84d':'#ffffff10'}`,borderRadius:6,padding:'3px 8px',fontSize:10,color:sel?'#e2e8f0':'#64748b',cursor:cp,whiteSpace:'nowrap'}} title={`${p.street} Â· ${p.count} tx Â· $${p.latestPsf} PSF`}>{p.sameStreet&&<span style={{marginRight:3}}>ğŸ“</span>}{p.name.length>25?p.name.substring(0,25)+'â€¦':p.name}</button>;})}
</div></Card>

{/* Capital Gain Table */}
{cmaCapGainData.length>0&&<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'16px 20px',borderBottom:'1px solid #ffffff10',display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:8}}>
<div><h3 style={{color:'#e2e8f0',fontSize:15,fontWeight:600,margin:0}}>ğŸ“ˆ Capital Gain Â· D{projInfo?.district}</h3>
<div style={{color:'#475569',fontSize:10,marginTop:2}}>Capital appreciation only (PSF growth) Â· excludes rental yield Â· CAGR = compound annual growth rate</div></div>
<div style={{display:'flex',gap:4,alignItems:'center'}}><span style={{color:'#64748b',fontSize:10,marginRight:4}}>Sort:</span>
{cmaPill('annReturn','Ann. CAGR',cmaSortBy,setCmaSortBy,'#a78bfa')}
{cmaPill('gainPct','Total %',cmaSortBy,setCmaSortBy,'#a78bfa')}
{cmaPill('latestPsf','Latest PSF',cmaSortBy,setCmaSortBy,'#a78bfa')}
{cmaPill('gainPsf','Gain $/sqft',cmaSortBy,setCmaSortBy,'#a78bfa')}
</div></div>
<div style={{padding:'0 20px 16px',overflowX:'auto'}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}>
<thead><tr style={{borderBottom:'1px solid #ffffff1a'}}>
<th style={{...thStyle,width:36}}></th>
<th style={thStyle}>Project</th>
<th style={{...thStyle,textAlign:'right'}}>First PSF</th>
<th style={{...thStyle,textAlign:'right'}}>Latest PSF</th>
<th style={{...thStyle,textAlign:'right'}}>Gain/sqft</th>
<th style={{...thStyle,textAlign:'right'}}>Total %</th>
<th style={{...thStyle,textAlign:'right'}}>Hold</th>
<th style={{...thStyle,textAlign:'right'}}>Ann. CAGR</th>
<th style={{...thStyle,textAlign:'right'}}>Txns</th>
</tr></thead>
<tbody>{cmaCapGainData.map((p,i)=>{const on=cmaSelected.includes(p.name)||p.isSubject;const nb=nearbyProjects.find(n=>n.name===p.name);return <tr key={p.name} onClick={()=>{if(!p.isSubject)toggleCma(p.name);}} style={{borderBottom:'1px solid #ffffff0a',background:p.isSubject?'#a78bfa06':i%2===0?'transparent':'#ffffff04',cursor:p.isSubject?'default':cp,transition:'background 0.1s'}} onMouseEnter={e=>{if(!p.isSubject)e.currentTarget.style.background='#ffffff0a';}} onMouseLeave={e=>{if(!p.isSubject)e.currentTarget.style.background=p.isSubject?'#a78bfa06':i%2===0?'transparent':'#ffffff04';}}>
<td style={{...tdStyle,textAlign:'center'}}><div style={{width:16,height:16,borderRadius:4,border:`2px solid ${p.isSubject?'#a78bfa':on?'#38bdf8':'#ffffff20'}`,background:p.isSubject?'#a78bfa':on?'#38bdf8':'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,color:'#0f172a',fontWeight:700}}>{(p.isSubject||on)&&'âœ“'}</div></td>
<td style={{...tdStyle,color:p.isSubject?'#a78bfa':on?'#e2e8f0':'#64748b',fontWeight:p.isSubject?700:500,maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}{p.isSubject&&<span style={{background:'#a78bfa26',color:'#a78bfa',fontSize:9,padding:'1px 6px',borderRadius:4,marginLeft:6,fontWeight:700}}>YOU</span>}</td>
<td style={{...tdStyle,textAlign:'right',color:'#94a3b8',fontFamily:fm}}>{$(p.firstPsf)} <span style={{color:'#475569',fontSize:9}}>'{String(p.firstYear).slice(2)}</span></td>
<td style={{...tdStyle,textAlign:'right',color:'#38bdf8',fontFamily:fm,fontWeight:600}}>{$(p.latestPsf)} <span style={{color:'#475569',fontSize:9}}>'{String(p.latestYear).slice(2)}</span></td>
<td style={{...tdStyle,textAlign:'right',color:p.gainPsf>=0?'#34d399':'#f87171',fontFamily:fm}}>{p.gainPsf>=0?'+':''}{$(p.gainPsf)}</td>
<td style={{...tdStyle,textAlign:'right',color:p.gainPct>=0?'#34d399':'#f87171',fontFamily:fm,fontWeight:600}}>{p.gainPct>=0?'+':''}{p.gainPct}%</td>
<td style={{...tdStyle,textAlign:'right',color:'#94a3b8',fontFamily:fm}}>{p.holdYears}yr</td>
<td style={{...tdStyle,textAlign:'right',color:p.annReturn>=0?'#4ade80':'#f87171',fontFamily:fm,fontWeight:700,fontSize:13}}>{p.annReturn>=0?'+':''}{p.annReturn}%</td>
<td style={{...tdStyle,textAlign:'right',color:'#64748b',fontFamily:fm}}>{p.isSubject?projTxAll.length:nb?.count||0}</td>
</tr>;})}</tbody></table></div>
<div style={{padding:'0 20px 12px',color:'#475569',fontSize:10,fontStyle:'italic'}}>Click rows to toggle in charts Â· Ann. CAGR = capital appreciation only (no rental income)</div>
</Card>}

{/* PSF Heatmap */}
{cmaHeatData.rows.length>0&&<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'16px 20px 12px',borderBottom:'1px solid #ffffff10'}}>
<h3 style={{color:'#e2e8f0',fontSize:15,fontWeight:600,margin:0}}>ğŸ”¥ Avg PSF Â· Project Ã— Year</h3>
<div style={{color:'#475569',fontSize:10,marginTop:2}}>Average price per square foot Â· darker = higher price</div></div>
<div style={{padding:'0 20px 20px',overflowX:'auto'}}><div style={{minWidth:400}}>
<div style={{display:'flex'}}><div style={{width:180,flexShrink:0}}/>{cmaHeatData.cols.map(y=><div key={y} style={{flex:1,minWidth:68,textAlign:'center',fontSize:11,fontWeight:500,color:'#94a3b8',padding:'8px 0',borderBottom:'1px solid #ffffff14'}}>{y}</div>)}<div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>{['Total %','Ann. CAGR'].map(h=><div key={h} style={{width:80,flexShrink:0,textAlign:'center',fontSize:10,fontWeight:600,color:'#64748b',padding:'8px 4px',borderBottom:'1px solid #ffffff14'}}>{h}</div>)}</div>
{cmaHeatData.rows.map((name,ri)=>{const isProj=name===analyzeProject;const nb=nearbyProjects.find(p=>p.name===name);const cgd=cmaCapGainData.find(p=>p.name===name);return <div key={name} style={{display:'flex',borderBottom:'1px solid #ffffff0a',background:isProj?'#a78bfa0a':'transparent'}}>
<div style={{width:180,flexShrink:0,fontSize:10,fontWeight:isProj?700:500,color:isProj?'#a78bfa':'#cbd5e1',padding:'10px 8px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',display:'flex',alignItems:'center',gap:4}} title={name}>{nb?.sameStreet&&!isProj&&<span style={{fontSize:8}}>ğŸ“</span>}{name.length>22?name.substring(0,22)+'â€¦':name}</div>
{cmaHeatData.cols.map(y=>{const k=`${name}-${y}`;const cell=cmaHeatData.map.get(k);if(!cell)return <div key={y} style={{flex:1,minWidth:68,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,color:'#475569'}}>â€“</div>;
const bg=getHC(cell.avg,cmaHeatData.mnP,cmaHeatData.mxP);const tc=getHT(cell.avg,cmaHeatData.mnP,cmaHeatData.mxP);return <div key={y} style={{flex:1,minWidth:68,height:40,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:500,background:bg,color:tc}} title={`${name} Â· ${y} Â· $${cell.avg.toLocaleString()} Â· ${cell.count} tx`}>${cell.avg.toLocaleString()}<span style={{fontSize:7,opacity:0.5}}>{cell.count}tx</span></div>;})}
<div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>
<div style={{width:80,flexShrink:0,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:700,color:cgd&&cgd.gainPct>=0?'#4ade80':'#f87171'}}>{cgd?`${cgd.gainPct>=0?'+':''}${cgd.gainPct}%`:'â€“'}</div>
<div style={{width:80,flexShrink:0,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:700,color:cgd&&cgd.annReturn>=0?'#34d399':'#f87171'}}>{cgd?`${cgd.annReturn>=0?'+':''}${cgd.annReturn}%`:'â€“'}</div>
</div>;})}
</div></div>
<div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:16,padding:'12px 20px',borderTop:'1px solid #ffffff0a'}}>
<div style={{display:'flex',alignItems:'center',gap:8}}><span style={{color:'#64748b',fontSize:10}}>Low PSF</span><div style={{width:80,height:8,borderRadius:4,background:'linear-gradient(90deg,#0ea5e940,#0ea5e9,#06b6d4)'}}/><span style={{color:'#64748b',fontSize:10}}>High PSF</span></div>
</div></Card>}

{/* Capital CAGR Heatmap */}
{cmaHeatData.rows.length>0&&<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'16px 20px 12px',borderBottom:'1px solid #ffffff10'}}>
<h3 style={{color:'#e2e8f0',fontSize:15,fontWeight:600,margin:0}}>ğŸ“ˆ Capital CAGR Â· Project Ã— Year</h3>
<div style={{color:'#475569',fontSize:10,marginTop:2}}>Annualized capital appreciation from first recorded year Â· <span style={{color:'#94a3b8',fontWeight:600}}>measures PSF growth only, excludes rental income</span></div></div>
<div style={{padding:'0 20px 20px',overflowX:'auto'}}><div style={{minWidth:400}}>
<div style={{display:'flex'}}><div style={{width:180,flexShrink:0}}/>{cmaHeatData.cols.map(y=><div key={y} style={{flex:1,minWidth:68,textAlign:'center',fontSize:11,fontWeight:500,color:'#94a3b8',padding:'8px 0',borderBottom:'1px solid #ffffff14'}}>{y}</div>)}<div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>{['Total %','Ann. CAGR'].map(h=><div key={h} style={{width:80,flexShrink:0,textAlign:'center',fontSize:10,fontWeight:600,color:'#64748b',padding:'8px 4px',borderBottom:'1px solid #ffffff14'}}>{h}</div>)}</div>
{cmaHeatData.rows.map((name,ri)=>{const isProj=name===analyzeProject;const nb=nearbyProjects.find(p=>p.name===name);const cgd=cmaCapGainData.find(p=>p.name===name);return <div key={name} style={{display:'flex',borderBottom:'1px solid #ffffff0a',background:isProj?'#a78bfa0a':'transparent'}}>
<div style={{width:180,flexShrink:0,fontSize:10,fontWeight:isProj?700:500,color:isProj?'#a78bfa':'#cbd5e1',padding:'10px 8px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',display:'flex',alignItems:'center',gap:4}} title={name}>{nb?.sameStreet&&!isProj&&<span style={{fontSize:8}}>ğŸ“</span>}{name.length>22?name.substring(0,22)+'â€¦':name}</div>
{cmaHeatData.cols.map(y=>{const k=`${name}-${y}`;const cell=cmaHeatData.map.get(k);if(!cell)return <div key={y} style={{flex:1,minWidth:68,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,color:'#475569'}}>â€“</div>;
const v=cell.annReturn;const isFirst=cell.isFirst;if(isFirst)return <div key={y} style={{flex:1,minWidth:68,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,color:'#64748b',fontStyle:'italic'}}>base</div>;const bg=getAC(v,cmaHeatData.mnA,cmaHeatData.mxA);const tc=getAT(v);return <div key={y} style={{flex:1,minWidth:68,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:600,background:bg,color:tc}} title={`${name} Â· ${y} Â· CAGR ${v}%/yr from ${cmaHeatData.cols[0]}`}>{v>=0?'+':''}{v}%</div>;})}
<div style={{width:1,flexShrink:0,background:'#ffffff1a'}}/>
<div style={{width:80,flexShrink:0,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:700,color:cgd&&cgd.gainPct>=0?'#4ade80':'#f87171'}}>{cgd?`${cgd.gainPct>=0?'+':''}${cgd.gainPct}%`:'â€“'}</div>
<div style={{width:80,flexShrink:0,height:40,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontFamily:fm,fontWeight:700,color:cgd&&cgd.annReturn>=0?'#34d399':'#f87171'}}>{cgd?`${cgd.annReturn>=0?'+':''}${cgd.annReturn}%`:'â€“'}</div>
</div>;})}
</div></div>
<div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:16,padding:'12px 20px',borderTop:'1px solid #ffffff0a'}}>
<div style={{display:'flex',alignItems:'center',gap:8}}><span style={{color:'#ef4444',fontSize:10}}>Negative</span><div style={{width:80,height:8,borderRadius:4,background:'linear-gradient(90deg,#ef4444,#1e293b,#22c55e)'}}/><span style={{color:'#22c55e',fontSize:10}}>Positive</span></div>
<span style={{color:'#475569',fontSize:10,fontStyle:'italic'}}>CAGR = (Current PSF Ã· First PSF)^(1/years) âˆ’ 1</span>
</div></Card>}

{/* PSF Trend */}
{cmaTrendData.length>0&&<Card><h3 style={h3s}>ğŸ“‰ PSF Trend Â· Year over Year</h3><div style={{height:380}}><ResponsiveContainer width="100%" height="100%"><LineChart data={cmaTrendData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="year" tick={{fill:'#64748b',fontSize:11}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={({active,payload,label})=>{if(!active||!payload?.length)return null;return <div style={{background:'#0f172af2',padding:'12px 16px',borderRadius:10,border:'1px solid #ffffff1a',fontSize:11,maxWidth:280}}><p style={{color:'#94a3b8',marginBottom:6,fontWeight:600}}>{label}</p>{payload.sort((a,b)=>(b.value||0)-(a.value||0)).map((p,i)=><p key={i} style={{color:p.color,margin:'2px 0',display:'flex',justifyContent:'space-between',gap:12}}><span>{p.name?.length>22?p.name.substring(0,22)+'â€¦':p.name}</span><span style={{fontFamily:fm,fontWeight:600}}>${p.value?.toLocaleString()}</span></p>)}</div>;}}/><Legend wrapperStyle={{fontSize:9,maxHeight:60,overflowY:'auto'}}/><Line type="monotone" dataKey={analyzeProject} name={analyzeProject.length>20?analyzeProject.substring(0,20)+'â€¦':analyzeProject} stroke="#a78bfa" strokeWidth={3} dot={{r:4,fill:'#a78bfa'}} connectNulls/>{cmaActive.map((p,i)=><Line key={p.name} type="monotone" dataKey={p.name} name={p.name.length>20?p.name.substring(0,20)+'â€¦':p.name} stroke={COLORS[i%COLORS.length]} strokeWidth={1.5} strokeDasharray={p.sameStreet?'':'5 3'} dot={{r:2}} connectNulls opacity={0.8}/>)}</LineChart></ResponsiveContainer></div></Card>}

{/* Project vs District vs Segment */}
<Card><h3 style={{color:'#e2e8f0',fontSize:14,fontWeight:600,marginBottom:4}}>Project vs District vs Segment</h3><p style={{color:'#64748b',fontSize:11,marginBottom:16}}>{analyzeProject} vs D{projInfo?.district} avg & {projInfo?.segment} avg</p><div style={{height:320}}><ResponsiveContainer width="100%" height="100%"><LineChart data={projComparison}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="date" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Legend wrapperStyle={{fontSize:11}}/><Line type="monotone" dataKey="project" name={analyzeProject.length>20?analyzeProject.substring(0,20)+'â€¦':analyzeProject} stroke="#a78bfa" strokeWidth={2.5} dot={{r:3,fill:'#a78bfa'}} connectNulls/><Line type="monotone" dataKey="district" name={`D${projInfo?.district} Avg`} stroke="#38bdf8" strokeWidth={1.5} strokeDasharray="5 5" dot={false} connectNulls/><Line type="monotone" dataKey="segment" name={`${projInfo?.segment} Avg`} stroke="#f59e0b" strokeWidth={1.5} strokeDasharray="3 3" dot={false} connectNulls/></LineChart></ResponsiveContainer></div></Card>
</div>;})()}
{}
{analyzeTab==='yield'&&(<div className={g2c}>
<Card style={{gridColumn:'1/-1'}}><h3 style={h3s}>ğŸ’° Investment</h3><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(150px,1fr))',gap:12}}><Stat label="Avg Buy PSF" value={projSaleStats?$(projSaleStats.avgPsf):'N/A'} color="#38bdf8" icon="ğŸ’°" sub=''/><Stat label="Avg Rent" value={projRentStats?`$${projRentStats.avgRent.toLocaleString()}`:'N/A'} color="#34d399" icon="ğŸ " sub=''/><Stat label="Rent PSF/mo" value={projRentStats?`$${projRentStats.avgRentPsf}`:'N/A'} color="#f59e0b" icon="ğŸ“" sub=''/><Stat label="Yield (All)" value={projYield?`${projYield}%`:'N/A'} color={projYield&&projYield>=3?'#22c55e':projYield&&projYield>=2.5?'#f59e0b':'#ef4444'} icon="ğŸ“Š" sub="All-time"/>{projLatestYield&&<Stat label={`Yield (${projLatestYield.year})`} value={`${projLatestYield.yield}%`} color={projLatestYield.yield>=3?'#22c55e':projLatestYield.yield>=2.5?'#f59e0b':'#ef4444'} icon="ğŸ¯" sub={`Buy $${Math.round(projLatestYield.buyPsf)} Â· Rent $${projLatestYield.rentPsf}/mo`}/>}</div></Card>
<Card><h3 style={h3s}>Price Trend</h3><div style={{height:280}}>{projPsfTrend.length?<ResponsiveContainer width="100%" height="100%"><AreaChart data={projPsfTrend}><defs><linearGradient id="pG" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#a78bfa" stopOpacity={0.3}/><stop offset="95%" stopColor="#a78bfa" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="date" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Area type="monotone" dataKey="avgPsf" name="PSF" stroke="#a78bfa" strokeWidth={2} fill="url(#pG)"/></AreaChart></ResponsiveContainer>:<div style={noDataS}>No data</div>}</div></Card>
<Card><h3 style={h3s}>Rental Trend</h3><div style={{height:280}}>{projRentTrend.length?<ResponsiveContainer width="100%" height="100%"><AreaChart data={projRentTrend}><defs><linearGradient id="rG" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#34d399" stopOpacity={0.3}/><stop offset="95%" stopColor="#34d399" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffffff10"/><XAxis dataKey="quarter" tick={{fill:'#64748b',fontSize:9}} axisLine={false}/><YAxis tick={{fill:'#64748b',fontSize:10}} axisLine={false} tickFormatter={v=>'$'+v.toLocaleString()}/><Tooltip content={<Tip/>}/><Area type="monotone" dataKey="avgRent" name="Avg Rent" stroke="#34d399" strokeWidth={2} fill="url(#rG)"/></AreaChart></ResponsiveContainer>:<div style={noDataS}>No data</div>}</div></Card>
</div>)}
{}
{analyzeTab==='records'&&(<div>
{}
<div style={{display:'flex',gap:0,marginBottom:16,background:'#ffffff0a',borderRadius:10,padding:3,width:'fit-content',border:'1px solid #ffffff10'}}>
<button onClick={()=>setRecordsView('sales')} style={{background:recordsView==='sales'?'#38bdf826':'transparent',border:recordsView==='sales'?'1px solid #38bdf84d':'1px solid transparent',borderRadius:8,padding:'7px 20px',color:recordsView==='sales'?'#38bdf8':'#64748b',fontSize:12,fontWeight:600,cursor:cp}}>ğŸ’° Sales ({projTx.length})</button>
<button onClick={()=>setRecordsView('rentals')} style={{background:recordsView==='rentals'?'#34d39926':'transparent',border:recordsView==='rentals'?'1px solid #34d3994d':'1px solid transparent',borderRadius:8,padding:'7px 20px',color:recordsView==='rentals'?'#34d399':'#64748b',fontSize:12,fontWeight:600,cursor:cp}}>ğŸ  Rentals ({projRent.length})</button>
</div>
{}
{recordsView==='sales'&&(
<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'16px 20px',borderBottom:'1px solid #ffffff10',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
<h3 style={{color:'#e2e8f0',fontSize:14,fontWeight:600,margin:0}}>Sale Transactions Â· {projTx.length} records</h3>
<span style={{color:'#64748b',fontSize:11}}>Click headers to sort</span>
</div>
<div style={{overflowX:'auto',maxHeight:500,overflowY:'auto'}}>
<table style={{width:'100%',borderCollapse:'collapse',fontSize:12,minWidth:800}}>
<thead style={{position:'sticky',top:0,background:'#1e293b',zIndex:2}}>
<tr style={{borderBottom:'1px solid #ffffff1a'}}>
<SortTh label="Date" field="contractDate" sortField={saleSortField} sortDir={saleSortDir} onSort={toggleSaleSort}/>
<SortTh label="Floor" field="floorRange" sortField={saleSortField} sortDir={saleSortDir} onSort={toggleSaleSort}/>
<SortTh label="Area (sqft)" field="areaSqft" sortField={saleSortField} sortDir={saleSortDir} onSort={toggleSaleSort} align="right"/>
<SortTh label="Price" field="priceNum" sortField={saleSortField} sortDir={saleSortDir} onSort={toggleSaleSort} align="right"/>
<SortTh label="PSF" field="psf" sortField={saleSortField} sortDir={saleSortDir} onSort={toggleSaleSort} align="right"/>
<SortTh label="Type" field="typeOfSale" sortField={saleSortField} sortDir={saleSortDir} onSort={toggleSaleSort}/>
</tr>
</thead>
<tbody>
{sortedProjTx.map((t,i)=>(
<tr key={t.id} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff04'}}>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,whiteSpace:'nowrap'}}>{t.contractDate}</td>
<td style={{...tdStyle,color:'#94a3b8',fontFamily:fm}}>{t.floorRange}</td>
<td style={{...tdStyle,color:'#94a3b8',fontFamily:fm,textAlign:'right'}}>{t.areaSqft.toLocaleString()}</td>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,textAlign:'right',fontWeight:600}}>{$c(t.priceNum)}</td>
<td style={{...tdStyle,color:'#38bdf8',fontFamily:fm,textAlign:'right',fontWeight:600}}>{$(t.psf)}</td>
<td style={{...tdStyle,color:t.typeOfSale==='New Sale'?'#34d399':t.typeOfSale==='Resale'?'#f59e0b':'#a78bfa'}}>{t.typeOfSale}</td>
</tr>
))}
</tbody>
</table>
</div>
</Card>
)}
{}
{recordsView==='rentals'&&(
<Card style={{padding:0,overflow:'hidden'}}>
<div style={{padding:'16px 20px',borderBottom:'1px solid #ffffff10',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
<h3 style={{color:'#e2e8f0',fontSize:14,fontWeight:600,margin:0}}>Rental Contracts Â· {projRent.length} records</h3>
<span style={{color:'#64748b',fontSize:11}}>Click headers to sort</span>
</div>
<div style={{overflowX:'auto',maxHeight:500,overflowY:'auto'}}>
<table style={{width:'100%',borderCollapse:'collapse',fontSize:12,minWidth:700}}>
<thead style={{position:'sticky',top:0,background:'#1e293b',zIndex:2}}>
<tr style={{borderBottom:'1px solid #ffffff1a'}}>
<SortTh label="Quarter" field="leaseDate" sortField={rentSortField} sortDir={rentSortDir} onSort={toggleRentSort}/>
<SortTh label="Bedrooms" field="noOfBedRoom" sortField={rentSortField} sortDir={rentSortDir} onSort={toggleRentSort}/>
<SortTh label="Area (sqft)" field="areaMid" sortField={rentSortField} sortDir={rentSortDir} onSort={toggleRentSort} align="right"/>
<SortTh label="Rent/mo" field="rent" sortField={rentSortField} sortDir={rentSortDir} onSort={toggleRentSort} align="right"/>
<th style={thStyle}>Rent PSF</th>
</tr>
</thead>
<tbody>
{sortedProjRent.map((r,i)=>{const q=pLQ(r.leaseDate);const mid=pAM(r.areaSqft);const rpsf=mid>0?(r.rent/mid):0;return(
<tr key={i} style={{borderBottom:'1px solid #ffffff0a',background:i%2===0?'transparent':'#ffffff04'}}>
<td style={{...tdStyle,color:'#e2e8f0',fontFamily:fm,whiteSpace:'nowrap'}}>{q?q.label:r.leaseDate}</td>
<td style={{...tdStyle,color:'#94a3b8'}}>{r.noOfBedRoom} BR</td>
<td style={{...tdStyle,color:'#94a3b8',fontFamily:fm,textAlign:'right'}}>{r.areaSqft}</td>
<td style={{...tdStyle,color:'#34d399',fontFamily:fm,textAlign:'right',fontWeight:600}}>${r.rent.toLocaleString()}</td>
<td style={{...tdStyle,color:'#f59e0b',fontFamily:fm,textAlign:'right'}}>{rpsf>0?`$${rpsf.toFixed(2)}`:'-'}</td>
</tr>
);})}
</tbody>
</table>
</div>
</Card>
)}
</div>)}
</div>
)}
</div>}
<div style={{textAlign:'center',padding:'20px 28px',borderTop:'1px solid #ffffff10',color:'#475569',fontSize:11}}>URA Property Analytics Â· {allTransactions.length.toLocaleString()} sales Â· {allRentals.length.toLocaleString()} rentals</div>
</div>
</>);
}
